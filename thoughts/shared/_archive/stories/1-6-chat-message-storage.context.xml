<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: 1-6-chat-message-storage
  Generated: 2026-01-15
  Purpose: Complete context for DEV agent implementation
-->
<story-context version="1.0">

  <!-- ========================================================================
       STORY IDENTIFICATION
       ======================================================================== -->
  <story>
    <id>1-6-chat-message-storage</id>
    <title>Chat Message Storage</title>
    <epic>1</epic>
    <epic-name>Foundation and First Chat</epic-name>
    <status>ready-for-dev</status>
    <priority>P0</priority>
  </story>

  <!-- ========================================================================
       USER STORY
       ======================================================================== -->
  <user-story>
    <as-a>user</as-a>
    <i-want>my conversations saved locally</i-want>
    <so-that>I can continue where I left off and search past chats</so-that>
  </user-story>

  <!-- ========================================================================
       ACCEPTANCE CRITERIA SUMMARY
       ======================================================================== -->
  <acceptance-criteria>
    <criterion id="AC1" priority="P0">
      <title>Message Persistence on Send</title>
      <summary>Messages persist to database with proper ID format (msg_xxx), conversation reference, role validation, timestamps, and automatic conversation stats updates (message_count, last_message_at)</summary>
    </criterion>

    <criterion id="AC2" priority="P0">
      <title>Conversation History Restoration</title>
      <summary>Conversation history restores from SQLite on app relaunch with messages in chronological order (oldest first), most recent conversation displayed by default</summary>
    </criterion>

    <criterion id="AC3" priority="P1">
      <title>Conversation Title Generation</title>
      <summary>Auto-generate title from first user message, truncate to 50 chars, allow manual override</summary>
    </criterion>

    <criterion id="AC4" priority="P1">
      <title>Conversation Timestamps</title>
      <summary>Display started_at and last_message_at in relative format ("2 hours ago")</summary>
    </criterion>

    <criterion id="AC5" priority="P0">
      <title>Message Role Validation</title>
      <summary>Only accept valid roles: user, assistant, system. Reject invalid roles with validation error</summary>
    </criterion>

    <criterion id="AC6" priority="P0">
      <title>Performance - Message Loading</title>
      <summary>100+ messages must load in under 500ms (NFR-P001), UI remains responsive</summary>
    </criterion>

    <criterion id="AC7" priority="P1">
      <title>Tool Call Storage</title>
      <summary>Store tool_calls and tool_results as JSON arrays in message records</summary>
    </criterion>

    <criterion id="AC8" priority="P1">
      <title>Conversation List View</title>
      <summary>Active conversations listed first, sorted by last_message_at DESC, archived hidden from main list</summary>
    </criterion>
  </acceptance-criteria>

  <!-- ========================================================================
       ATDD TEST CHECKLIST REFERENCE
       ======================================================================== -->
  <test-checklist>
    <reference-file>./atdd-checklist-1-6-chat-message-storage.md</reference-file>
    <summary>
      <unit-tests count="21" p0="12" p1="9"/>
      <integration-tests count="10" p0="6" p1="4"/>
      <e2e-tests count="8" p0="4" p1="4"/>
      <total-tests count="39"/>
    </summary>
    <critical-tests>
      <test id="1.6-UNIT-001">createMessage generates valid msg_ ID</test>
      <test id="1.6-UNIT-003">createMessage increments conversation message_count</test>
      <test id="1.6-UNIT-005">getMessagesByConversation returns chronological order</test>
      <test id="1.6-UNIT-016">validateRole accepts only user/assistant/system</test>
      <test id="1.6-INT-003">Messages persist across database restart</test>
      <test id="1.6-INT-008">100 messages load under 500ms</test>
      <test id="1.6-E2E-001">Conversation history restored on app launch</test>
    </critical-tests>
  </test-checklist>

  <!-- ========================================================================
       ARCHITECTURE PATTERNS
       ======================================================================== -->
  <architecture>

    <!-- Database Configuration -->
    <database>
      <location>~/Library/Application Support/Orion/orion.db</location>
      <type>SQLite with WAL mode</type>
      <pragmas>
        <pragma>journal_mode=WAL</pragma>
        <pragma>foreign_keys=ON</pragma>
        <pragma>cache_size=-64000 (64MB)</pragma>
      </pragmas>
    </database>

    <!-- Schema: conversations table -->
    <schema table="conversations">
      <![CDATA[
CREATE TABLE conversations (
    id TEXT PRIMARY KEY,                     -- conv_xxx format
    sdk_session_id TEXT,                     -- Claude SDK session ID
    title TEXT,
    summary TEXT,
    project_id TEXT REFERENCES projects(id),
    area_id TEXT REFERENCES areas(id),
    message_count INTEGER DEFAULT 0,
    tool_call_count INTEGER DEFAULT 0,
    is_active INTEGER DEFAULT 1,
    is_pinned INTEGER DEFAULT 0,
    tags TEXT,
    metadata TEXT,
    started_at TEXT DEFAULT (datetime('now')),
    last_message_at TEXT,
    archived_at TEXT
);

CREATE INDEX idx_conversations_active ON conversations(is_active, last_message_at DESC);
      ]]>
    </schema>

    <!-- Schema: messages table -->
    <schema table="messages">
      <![CDATA[
CREATE TABLE messages (
    id TEXT PRIMARY KEY,                     -- msg_xxx format
    conversation_id TEXT NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    role TEXT NOT NULL,                      -- user | assistant | system
    content TEXT NOT NULL,
    tool_calls TEXT,                         -- JSON array
    tool_results TEXT,                       -- JSON array
    input_tokens INTEGER,
    output_tokens INTEGER,
    feedback TEXT,                           -- thumbs_up | thumbs_down
    feedback_note TEXT,
    metadata TEXT,
    created_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at);
      ]]>
    </schema>

    <!-- ID Generation Pattern -->
    <id-generation>
      <pattern>prefix + crypto.randomBytes(8).toString('base64url').slice(0, 11)</pattern>
      <prefixes>
        <prefix entity="message">msg_</prefix>
        <prefix entity="conversation">conv_</prefix>
      </prefixes>
      <note>Use existing utilities from src/lib/db/ids.ts if available from Story 1.4</note>
    </id-generation>

    <!-- TypeScript Types -->
    <types>
      <![CDATA[
// MessageRole - strict enum
type MessageRole = 'user' | 'assistant' | 'system';

// Message entity
interface Message {
  id: string;                    // msg_xxx
  conversation_id: string;       // conv_xxx
  role: MessageRole;
  content: string;
  tool_calls?: unknown[] | null;
  tool_results?: unknown[] | null;
  input_tokens?: number | null;
  output_tokens?: number | null;
  feedback?: 'thumbs_up' | 'thumbs_down' | null;
  feedback_note?: string | null;
  metadata?: Record<string, unknown> | null;
  created_at: string;            // ISO8601
}

// Conversation entity
interface Conversation {
  id: string;                    // conv_xxx
  sdk_session_id?: string | null;
  title?: string | null;
  summary?: string | null;
  project_id?: string | null;
  area_id?: string | null;
  message_count: number;
  tool_call_count: number;
  is_active: number;             // 0 or 1 (SQLite boolean)
  is_pinned: number;             // 0 or 1
  tags?: string | null;          // JSON array string
  metadata?: string | null;      // JSON string
  started_at: string;
  last_message_at?: string | null;
  archived_at?: string | null;
}
      ]]>
    </types>
  </architecture>

  <!-- ========================================================================
       IMPLEMENTATION TASKS
       ======================================================================== -->
  <tasks>

    <task id="1" title="Message Service Layer" acs="AC1,AC5,AC7">
      <files>
        <create>src/lib/db/services/messageService.ts</create>
      </files>
      <functions>
        <function>validateRole(role: string): role is MessageRole</function>
        <function>createMessage(data: CreateMessageData): Message</function>
        <function>getMessage(id: string): Message | null</function>
        <function>getMessagesByConversation(conversationId: string, options?: PaginationOptions): Message[]</function>
      </functions>
      <requirements>
        <item>Validate role before insert - throw on invalid</item>
        <item>Generate msg_xxx ID using crypto.randomBytes</item>
        <item>Serialize tool_calls/tool_results to JSON on write</item>
        <item>Parse JSON on read</item>
        <item>Call updateConversationStats after insert</item>
      </requirements>
    </task>

    <task id="2" title="Conversation Service Layer" acs="AC2,AC3,AC4,AC8">
      <files>
        <create>src/lib/db/services/conversationService.ts</create>
      </files>
      <functions>
        <function>createConversation(data?: CreateConversationData): Conversation</function>
        <function>getConversation(id: string): Conversation | null</function>
        <function>listActiveConversations(): Conversation[]</function>
        <function>updateConversationStats(conversationId: string, lastMessageAt: string): void</function>
        <function>updateConversationTitle(id: string, title: string): void</function>
        <function>generateTitle(firstMessage: string): string</function>
      </functions>
      <requirements>
        <item>Generate conv_xxx ID using crypto.randomBytes</item>
        <item>Title generation: extract first sentence, truncate at 50 chars with "..."</item>
        <item>List active: WHERE is_active=1 ORDER BY last_message_at DESC</item>
        <item>Update stats: INCREMENT message_count, SET last_message_at</item>
      </requirements>
    </task>

    <task id="3" title="Message Retrieval with Performance" acs="AC2,AC6">
      <requirements>
        <item>Query: SELECT * FROM messages WHERE conversation_id=? ORDER BY created_at ASC</item>
        <item>Verify index exists on (conversation_id, created_at)</item>
        <item>Support pagination with LIMIT/OFFSET</item>
        <item>Target: less than 500ms for 100 messages</item>
        <item>Parse JSON fields (tool_calls, tool_results) on retrieval</item>
      </requirements>
    </task>

    <task id="4" title="Tauri IPC Commands" acs="AC1,AC2,AC4">
      <files>
        <create>src/lib/tauri/commands/chat.ts</create>
        <create>src-tauri/src/commands/chat.rs</create>
      </files>
      <commands>
        <command>create_conversation</command>
        <command>get_conversation</command>
        <command>list_conversations</command>
        <command>update_conversation_title</command>
        <command>send_message</command>
        <command>get_messages</command>
        <command>save_assistant_message</command>
      </commands>
      <note>Rust commands in src-tauri/src/commands/chat.rs call TypeScript services via appropriate bridging</note>
    </task>

    <task id="5" title="React Chat State Management" acs="AC2,AC4,AC8">
      <files>
        <create>src/stores/chatStore.ts</create>
      </files>
      <state-shape>
        <![CDATA[
interface ChatState {
  conversations: Conversation[];
  activeConversationId: string | null;
  messages: Message[];
  isLoading: boolean;
  error: string | null;
}
        ]]>
      </state-shape>
      <actions>
        <action>loadConversations(): Promise&lt;void&gt;</action>
        <action>selectConversation(id: string): Promise&lt;void&gt;</action>
        <action>createNewConversation(): Promise&lt;Conversation&gt;</action>
        <action>sendUserMessage(content: string): Promise&lt;Message&gt;</action>
        <action>appendAssistantMessage(message: Partial&lt;Message&gt;): void</action>
        <action>updateConversationTitle(id: string, title: string): Promise&lt;void&gt;</action>
      </actions>
      <requirements>
        <item>Use Zustand with immer middleware</item>
        <item>Load conversations on app start</item>
        <item>Auto-select most recent conversation</item>
        <item>Optimistic updates for sent messages</item>
      </requirements>
    </task>

    <task id="6" title="Conversation List UI Component" acs="AC4,AC8">
      <files>
        <create>src/components/chat/ConversationList.tsx</create>
      </files>
      <requirements>
        <item>New Conversation button with btn-gold-slide class</item>
        <item>List conversations sorted by last_message_at DESC</item>
        <item>Highlight active conversation</item>
        <item>Show relative timestamps (formatRelativeTime)</item>
        <item>Use Orion Design System tokens</item>
      </requirements>
    </task>

    <task id="7" title="Message History Component" acs="AC2,AC6">
      <files>
        <create>src/components/chat/MessageHistory.tsx</create>
        <create>src/components/chat/MessageBubble.tsx</create>
      </files>
      <requirements>
        <item>Display messages in chronological order</item>
        <item>Auto-scroll to latest message on new messages</item>
        <item>Loading state while fetching</item>
        <item>Role-based styling: .chat-user for user, .chat-agent for assistant</item>
      </requirements>
    </task>

    <task id="8" title="Title Auto-Generation" acs="AC3">
      <files>
        <create>src/lib/utils/titleGenerator.ts</create>
      </files>
      <algorithm>
        <step>Extract first sentence (split on .!?)</step>
        <step>Remove filler phrases (hi, hey, hello, can you, please, could you, i want to, i need to)</step>
        <step>Capitalize first letter</step>
        <step>Truncate to 47 chars + "..." if over 50</step>
        <step>Return "New Conversation" if empty</step>
      </algorithm>
      <trigger>On first user message in a conversation with no title</trigger>
    </task>

    <task id="9" title="Integration with Existing Database" acs="AC1,AC2,AC5">
      <dependencies>
        <dependency story="1.4">SQLite Database Setup must be complete</dependency>
      </dependencies>
      <requirements>
        <item>Verify conversations and messages tables exist</item>
        <item>Verify CHECK constraint on role column (if not, add via application validation)</item>
        <item>Verify foreign key from messages.conversation_id to conversations.id</item>
        <item>Test CASCADE delete (messages deleted when conversation deleted)</item>
      </requirements>
    </task>

    <task id="10" title="Date Formatting Utility" acs="AC4">
      <files>
        <create>src/lib/utils/date.ts</create>
      </files>
      <functions>
        <function>formatRelativeTime(dateString: string | null): string</function>
        <function>formatTimestamp(dateString: string): string</function>
      </functions>
      <relative-time-rules>
        <rule condition="less than 60 seconds">Just now</rule>
        <rule condition="less than 60 minutes">X minute(s) ago</rule>
        <rule condition="less than 24 hours">X hour(s) ago</rule>
        <rule condition="less than 7 days">X day(s) ago</rule>
        <rule condition="7+ days">toLocaleDateString()</rule>
      </relative-time-rules>
    </task>

    <task id="11" title="Unit Tests" acs="AC1,AC2,AC3,AC5,AC7">
      <files>
        <create>tests/unit/services/messageService.test.ts</create>
        <create>tests/unit/services/conversationService.test.ts</create>
        <create>tests/unit/utils/titleGenerator.test.ts</create>
        <create>tests/unit/utils/date.test.ts</create>
      </files>
      <framework>Vitest</framework>
      <setup>In-memory SQLite database with migrations</setup>
    </task>

    <task id="12" title="Integration Tests" acs="AC2,AC6">
      <files>
        <create>tests/integration/chat/persistence.test.ts</create>
        <create>tests/integration/chat/performance.test.ts</create>
      </files>
      <framework>Vitest</framework>
      <key-tests>
        <test>Messages persist across database restart</test>
        <test>100 messages load in under 500ms</test>
        <test>Conversation list excludes archived</test>
      </key-tests>
    </task>

    <task id="13" title="E2E Tests" acs="AC2,AC6">
      <files>
        <create>tests/e2e/chat-storage.spec.ts</create>
      </files>
      <framework>Playwright</framework>
      <key-tests>
        <test>Message persists after app restart</test>
        <test>100 messages load quickly</test>
        <test>Conversation title auto-generates</test>
      </key-tests>
    </task>

  </tasks>

  <!-- ========================================================================
       DIRECTORY STRUCTURE
       ======================================================================== -->
  <directory-structure>
    <![CDATA[
src/
  lib/
    db/
      services/
        messageService.ts        # CREATE: Message CRUD
        conversationService.ts   # CREATE: Conversation CRUD
    tauri/
      commands/
        chat.ts                  # CREATE: Tauri IPC commands
    utils/
      date.ts                    # CREATE: Date formatting
      titleGenerator.ts          # CREATE: Title generator
  stores/
    chatStore.ts                 # CREATE: Zustand store
  components/
    chat/
      ConversationList.tsx       # CREATE
      MessageHistory.tsx         # CREATE
      MessageBubble.tsx          # CREATE

src-tauri/src/
  commands/
    chat.rs                      # CREATE: Rust commands

tests/
  unit/
    services/
      messageService.test.ts     # CREATE
      conversationService.test.ts # CREATE
    utils/
      titleGenerator.test.ts     # CREATE
      date.test.ts               # CREATE
  integration/
    chat/
      persistence.test.ts        # CREATE
      performance.test.ts        # CREATE
  e2e/
    chat-storage.spec.ts         # CREATE
    ]]>
  </directory-structure>

  <!-- ========================================================================
       DEPENDENCIES
       ======================================================================== -->
  <dependencies>
    <story-dependencies>
      <required story="1.4" name="SQLite Database Setup">Provides database tables and connection</required>
      <required story="1.2" name="Next.js Frontend Integration">Provides React infrastructure</required>
    </story-dependencies>
    <npm-dependencies>
      <already-installed>better-sqlite3</already-installed>
      <already-installed>@types/better-sqlite3</already-installed>
      <already-installed>zustand</already-installed>
      <already-installed>zustand/middleware/immer</already-installed>
    </npm-dependencies>
    <note>No new dependencies required</note>
  </dependencies>

  <!-- ========================================================================
       CRITICAL CONSTRAINTS
       ======================================================================== -->
  <constraints>
    <constraint id="ARCH-007">Database Location: ~/Library/Application Support/Orion/orion.db</constraint>
    <constraint id="ID-MSG">Message ID Format: msg_xxx (11 char base64url suffix)</constraint>
    <constraint id="ID-CONV">Conversation ID Format: conv_xxx (11 char base64url suffix)</constraint>
    <constraint id="ROLE">Valid Roles: user, assistant, system (case-sensitive, lowercase)</constraint>
    <constraint id="NFR-P001">Performance: 100 messages load in less than 500ms</constraint>
    <constraint id="NFR-S001">Local-First: All data stays on device</constraint>
    <constraint id="TITLE-LEN">Title max length: 50 characters</constraint>
  </constraints>

  <!-- ========================================================================
       DESIGN SYSTEM NOTES
       ======================================================================== -->
  <design-system>
    <css-classes>
      <class name="btn-gold-slide">Primary CTA button with gold slide hover</class>
      <class name="chat-user">User message bubble (black bg, cream text)</class>
      <class name="chat-agent">Agent message bubble (gold left border)</class>
    </css-classes>
    <colors>
      <color name="orion-primary">#D4AF37 (gold)</color>
      <color name="orion-bg">#F9F8F6 (cream)</color>
      <color name="orion-fg">#1A1A1A (black)</color>
    </colors>
  </design-system>

  <!-- ========================================================================
       PERFORMANCE BENCHMARKS
       ======================================================================== -->
  <benchmarks>
    <benchmark operation="Load 100 messages" target="less than 500ms"/>
    <benchmark operation="Insert message" target="less than 50ms"/>
    <benchmark operation="List conversations" target="less than 100ms"/>
    <benchmark operation="Title generation" target="less than 10ms (sync)"/>
  </benchmarks>

  <!-- ========================================================================
       REFERENCES
       ======================================================================== -->
  <references>
    <reference>thoughts/planning-artifacts/architecture.md#4.1 SQLite Schema</reference>
    <reference>thoughts/planning-artifacts/architecture.md#4.2 TypeScript Types</reference>
    <reference>thoughts/planning-artifacts/prd.md#5.1.1 Chat Interface - FR-CH002</reference>
    <reference>thoughts/planning-artifacts/prd.md#NFR-P001 Message latency requirements</reference>
    <reference>thoughts/implementation-artifacts/stories/story-1-4-sqlite-database-setup.md</reference>
  </references>

</story-context>
