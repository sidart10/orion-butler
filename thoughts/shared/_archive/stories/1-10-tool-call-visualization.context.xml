<?xml version="1.0" encoding="UTF-8"?>
<story-context id="1-10-tool-call-visualization" epic="1">
  <metadata>
    <created>2026-01-15T12:00:00Z</created>
    <status>ready-for-dev</status>
    <story-file>story-1-10-tool-call-visualization.md</story-file>
    <atdd-checklist>atdd-checklist-1-10-tool-call-visualization.md</atdd-checklist>
  </metadata>

  <story>
    <overview>
      As a user, I want to see what tools Orion is using during a conversation,
      so that I understand what's happening and can trust the AI's actions.

      Tool cards appear during Claude's response to show tool invocations with
      collapsible details, status indicators, input/output display, and XSS protection.
    </overview>

    <acceptance-criteria>
      <criterion id="AC1">Tool Card Appears on Invocation - When Claude invokes a tool (tool_start event), a collapsible card appears showing tool name, icon, and running status indicator (animated spinner)</criterion>
      <criterion id="AC2">Tool Card Shows Input Parameters - Card shows summarized input (max 80 chars) with truncation, full view on expand</criterion>
      <criterion id="AC3">Tool Card Expand/Collapse - Click toggles expand state, shows full JSON with syntax highlighting, 300ms ease animation</criterion>
      <criterion id="AC4">Tool Card Shows Output Result - On tool_complete event, card shows green checkmark and summarized output (max 80 chars)</criterion>
      <criterion id="AC5">Tool Card Error State - On tool_error event, card shows red X icon, error message, distinct red border/background styling</criterion>
      <criterion id="AC6">Multiple Tools Stack Correctly - Each tool gets its own card in sequence with timing/duration shown (e.g., "1.2s")</criterion>
      <criterion id="AC7">Tool Card XSS Protection - All content properly escaped, no script execution, JSON displayed as text not interpreted</criterion>
      <criterion id="AC8">Tool Card Design Compliance - Follows Orion Design System (gold accent, sharp corners), collapsed max 60px height, monospace JSON font</criterion>
      <criterion id="AC9">Tool Card Accessibility - Keyboard focusable/expandable via Enter/Space, aria-expanded reflects state, screen reader announcements</criterion>
      <criterion id="AC10">Tool Card Integration with Chat Flow - Tool cards appear inline at correct position during streaming, interleaved text/tool events handled correctly</criterion>
    </acceptance-criteria>

    <dependencies>
      <dependency type="story">Story 1-8 (Streaming Responses) - provides stream event handling</dependency>
      <dependency type="story">Story 1-9 (Split-Screen Layout) - provides framer-motion dependency</dependency>
      <dependency type="library">framer-motion - for expand/collapse animation</dependency>
      <dependency type="library">zustand - state management for tool tracking</dependency>
      <dependency type="library">lucide-react - icons (CheckCircle2, XCircle, Loader2, Wrench, ChevronDown, ChevronUp)</dependency>
    </dependencies>

    <technical-notes>
      <note category="streaming">Handle tool_start, tool_input, tool_complete, tool_error stream events</note>
      <note category="store">Extend ToolStatus interface to include input, output, startTime, endTime fields</note>
      <note category="security">Use textContent-based escaping, never dangerouslySetInnerHTML with tool data</note>
      <note category="performance">Use useMemo for JSON formatting, debounce rapid status updates</note>
      <note category="xss-test-cases">Test: script tags, img onerror, encoded variants, template literals, unicode homoglyphs</note>
    </technical-notes>
  </story>

  <tests>
    <atdd-checklist-ref>atdd-checklist-1-10-tool-call-visualization.md</atdd-checklist-ref>
    <test-summary>
      <total-tests>65</total-tests>
      <by-type>
        <unit>26</unit>
        <integration>9</integration>
        <e2e>21</e2e>
        <visual>3</visual>
      </by-type>
    </test-summary>
    <test-locations>
      <location type="unit">tests/unit/components/chat/ToolCard.test.tsx</location>
      <location type="unit">tests/unit/components/chat/ToolCardList.test.tsx</location>
      <location type="unit">tests/unit/components/chat/summarizeJson.test.ts</location>
      <location type="unit">tests/unit/components/chat/escapeHtml.test.ts</location>
      <location type="integration">tests/integration/stores/chatStore-tools.test.ts</location>
      <location type="integration">tests/integration/streaming/tool-events.test.ts</location>
      <location type="e2e">tests/e2e/tool-cards.spec.ts</location>
      <location type="visual">tests/e2e/tool-cards-visual.spec.ts</location>
    </test-locations>
    <gate-criteria>
      <criterion>All 65 tests pass</criterion>
      <criterion>Unit test coverage >= 80% for ToolCard, ToolCardList</criterion>
      <criterion>Visual regression approved (3 snapshots)</criterion>
      <criterion>No XSS vulnerabilities (AC7 tests critical)</criterion>
      <criterion>Accessibility audit passes (axe-core)</criterion>
      <criterion>Performance: 10+ tool cards render less than 500ms</criterion>
      <criterion>Code review approved</criterion>
      <criterion>No P0/P1 bugs open</criterion>
    </gate-criteria>
  </tests>

  <architecture>
    <relevant-sections>
      <section id="7.2" title="State Management - Chat Store">
        <content><![CDATA[
interface ToolStatus {
  id: string;
  name: string;
  status: 'pending' | 'running' | 'complete' | 'error';
  result?: unknown;
  // Story 1.10 additions needed:
  input?: Record<string, unknown>;
  output?: unknown;
  error?: string;
  startTime?: number;
  endTime?: number;
}

interface ChatState {
  messages: Message[];
  isStreaming: boolean;
  currentStreamId: string | null;
  activeTools: ToolStatus[];
  error: string | null;
  sessionId: string | null;

  // Actions
  addTool: (tool: ToolStatus) => void;
  updateTool: (id: string, updates: Partial<ToolStatus>) => void;
  // Story 1.10 addition needed:
  clearTools: () => void;
}
        ]]></content>
      </section>

      <section id="12.1" title="Streaming Architecture - Message Protocol">
        <content><![CDATA[
export type StreamEventType =
  | 'thinking'
  | 'text'
  | 'tool_start'    // Tool invocation begins
  | 'tool_input'    // Tool input parameters
  | 'tool_complete' // Tool execution successful
  | 'tool_error'    // Tool execution failed
  | 'session'
  | 'result'
  | 'complete'
  | 'error';

export interface StreamEvent {
  type: StreamEventType;
  timestamp: number;

  // Text content
  content?: string;

  // Tool events
  toolId?: string;
  toolName?: string;
  toolInput?: Record<string, unknown>;
  toolResult?: unknown;
  toolError?: string;

  // Session info
  sessionId?: string;

  // Result info
  durationMs?: number;
  totalCost?: number;
  inputTokens?: number;
  outputTokens?: number;

  // Error
  error?: string;
}
        ]]></content>
      </section>
    </relevant-sections>

    <patterns-to-follow>
      <pattern name="Zustand Immer Pattern">Use immer middleware for immutable state updates in chatStore</pattern>
      <pattern name="Event Stream Handling">Switch on event.type in streaming handler, dispatch to appropriate store actions</pattern>
      <pattern name="Component Composition">ToolCardList contains ToolCard components with proper key props</pattern>
      <pattern name="Accessibility Pattern">aria-expanded, aria-controls, keyboard handlers for Enter/Space</pattern>
      <pattern name="Animation Pattern">framer-motion AnimatePresence with motion.div for expand/collapse</pattern>
    </patterns-to-follow>

    <directory-structure>
      <file action="CREATE">src/components/chat/ToolCard.tsx</file>
      <file action="CREATE">src/components/chat/ToolCardList.tsx</file>
      <file action="MODIFY">src/components/chat/ChatPanel.tsx - integrate tool events</file>
      <file action="MODIFY">src/stores/chatStore.ts - add input/output/timing to ToolStatus</file>
      <file action="EXISTS">src/types/streaming.ts - stream event types already defined</file>
      <file action="DEPRECATE">src/components/chat/ToolStatusBar.tsx - may be replaced by ToolCardList</file>
      <file action="CREATE">tests/unit/components/chat/ToolCard.test.tsx</file>
      <file action="CREATE">tests/e2e/tool-cards.spec.ts</file>
    </directory-structure>
  </architecture>

  <ux-context>
    <design-system-ref>thoughts/planning-artifacts/design-system-adoption.md</design-system-ref>
    <ux-spec-ref>thoughts/planning-artifacts/ux-design-specification.md</ux-spec-ref>

    <design-tokens>
      <token name="Card Border" class="border-orion-fg/10" value="#1A1A1A @ 10%"/>
      <token name="Card Background" class="bg-orion-bg/50" value="#F9F8F6 @ 50%"/>
      <token name="Running Status" class="text-orion-primary" value="#D4AF37"/>
      <token name="Complete Status" class="text-green-600" value="Green checkmark"/>
      <token name="Error Status" class="text-red-600" value="Red X"/>
      <token name="Error Border" class="border-red-500/50" value="Red border"/>
      <token name="Error Background" class="bg-red-50/10" value="Light red tint"/>
      <token name="JSON Font" class="font-mono" value="Monospace"/>
      <token name="Label Tracking" class="tracking-editorial" value="0.25em"/>
      <token name="Animation Duration" value="300ms" curve="easeInOut"/>
      <token name="Border Radius" value="0" note="Sharp corners, no radius"/>
    </design-tokens>

    <component-guidelines>
      <guideline category="layout">Collapsed card max 60px height, expand shows full JSON</guideline>
      <guideline category="typography">Tool name in font-mono, labels in uppercase with tracking-editorial</guideline>
      <guideline category="colors">Sharp corners (no border-radius), gold accent for running state, monochrome base</guideline>
      <guideline category="animation">300ms ease expand/collapse, use framer-motion AnimatePresence</guideline>
      <guideline category="interaction">Button wrapper for click handling, visual focus ring on keyboard focus</guideline>
    </component-guidelines>

    <chat-integration>
      <pattern name="Chat Agent Message">chat-agent class with pl-4 border-l-2 border-orion-primary/30</pattern>
      <pattern name="Inline Tool Cards">Tool cards appear inline within assistant message flow</pattern>
      <pattern name="Status Indicators">Use Loader2 (animate-spin) for running, CheckCircle2 for complete, XCircle for error</pattern>
    </chat-integration>
  </ux-context>

  <implementation-guidance>
    <task id="1" title="Create ToolCard Component" priority="high">
      <files>src/components/chat/ToolCard.tsx</files>
      <description>
        Create the main ToolCard component with:
        - Props: id, name, status, input, output, error, duration, className
        - Collapsed/expanded states with animation
        - Status icons (spinner/checkmark/X)
        - XSS-safe rendering of JSON via escapeHtml helper
        - Accessibility: button wrapper, aria-expanded, keyboard handlers
      </description>
      <acceptance-criteria>AC1, AC2, AC3, AC4, AC5, AC8, AC9</acceptance-criteria>
    </task>

    <task id="2" title="Create ToolCardList Component" priority="high">
      <files>src/components/chat/ToolCardList.tsx</files>
      <description>
        Container component that:
        - Renders array of ToolCard components
        - Maintains sequential order
        - Adds list semantics (role="list", role="listitem")
      </description>
      <acceptance-criteria>AC6, AC10</acceptance-criteria>
    </task>

    <task id="3" title="Update Chat Store for Tool Tracking" priority="high">
      <files>src/stores/chatStore.ts</files>
      <description>
        Extend ToolStatus interface to include:
        - input: Record of input parameters
        - output: Tool result data
        - error: Error message string
        - startTime: Timestamp when tool started
        - endTime: Timestamp when tool completed
        Add clearTools action for conversation reset
      </description>
      <acceptance-criteria>AC1, AC4, AC5, AC6</acceptance-criteria>
    </task>

    <task id="4" title="Integrate Tool Events with Streaming" priority="high">
      <files>src/components/chat/ChatPanel.tsx</files>
      <description>
        Handle stream events:
        - tool_start: addTool with id, name, status='running', input, startTime
        - tool_input: updateTool with input (if sent separately)
        - tool_complete: updateTool with status='complete', output, endTime
        - tool_error: updateTool with status='error', error, endTime
      </description>
      <acceptance-criteria>AC1, AC4, AC5, AC10</acceptance-criteria>
    </task>

    <task id="5" title="Integrate ToolCardList into Chat Flow" priority="medium">
      <files>src/components/chat/ChatPanel.tsx or MessageList.tsx</files>
      <description>
        Position ToolCardList in chat message area:
        - Map activeTools to ToolCardProps with calculated duration
        - Handle interleaved text and tool events
        - Clear tools on new conversation
      </description>
      <acceptance-criteria>AC10</acceptance-criteria>
    </task>

    <task id="6" title="Style with Orion Design System" priority="medium">
      <files>src/components/chat/ToolCard.tsx</files>
      <description>
        Apply design tokens:
        - Sharp corners (no border-radius)
        - Gold accent for running state border
        - Cream background, black text
        - Monospace font for JSON
        - Editorial tracking for labels
        - Compact collapsed height (max 60px)
      </description>
      <acceptance-criteria>AC8</acceptance-criteria>
    </task>

    <task id="7" title="Unit Tests for ToolCard" priority="high">
      <files>tests/unit/components/chat/ToolCard.test.tsx</files>
      <description>
        Test coverage for:
        - Rendering tool name and status icons
        - Expand/collapse state changes
        - XSS protection with malicious payloads
        - All status states (pending, running, complete, error)
        - Keyboard accessibility
        - Duration display formatting
      </description>
      <acceptance-criteria>AC7, AC8, AC9</acceptance-criteria>
    </task>

    <task id="8" title="E2E Tests for Tool Visualization" priority="high">
      <files>tests/e2e/tool-cards.spec.ts</files>
      <description>
        Playwright tests for:
        - Tool card appears on invocation
        - Card expand/collapse interaction
        - Multiple tool cards stacking
        - Visual regression snapshots (collapsed, expanded, error states)
      </description>
      <acceptance-criteria>AC1, AC3, AC6</acceptance-criteria>
    </task>

    <task id="9" title="Replace ToolStatusBar with ToolCardList" priority="low">
      <files>src/components/chat/ChatPanel.tsx, src/components/chat/ToolStatusBar.tsx</files>
      <description>
        Update ChatPanel to use ToolCardList instead of ToolStatusBar.
        Deprecate or remove ToolStatusBar if no longer needed.
        Ensure backward compatibility during transition.
      </description>
      <acceptance-criteria>AC10</acceptance-criteria>
    </task>
  </implementation-guidance>

  <references>
    <reference type="epic">thoughts/planning-artifacts/epics.md#Story 1.10</reference>
    <reference type="prd">thoughts/planning-artifacts/prd.md#5.1.1 Chat Interface (FR-CH004)</reference>
    <reference type="architecture">thoughts/planning-artifacts/architecture.md#Section 7.2 - Chat State Store</reference>
    <reference type="architecture">thoughts/planning-artifacts/architecture.md#Section 12 - Streaming Architecture</reference>
    <reference type="test-design">thoughts/planning-artifacts/test-design-epic-1.md#Story 1.10</reference>
    <reference type="design-system">thoughts/planning-artifacts/design-system-adoption.md</reference>
    <reference type="ux-spec">thoughts/planning-artifacts/ux-design-specification.md</reference>
  </references>
</story-context>
