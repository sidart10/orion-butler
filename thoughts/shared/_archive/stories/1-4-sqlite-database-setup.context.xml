<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: 1-4-sqlite-database-setup
  Generated: 2026-01-15
  Epic: 1 - Foundation & Core Chat
  Status: ready-for-dev

  This file provides all context needed for the DEV agent to implement
  this story without additional lookups.
-->
<story-context>
  <metadata>
    <story-id>1-4-sqlite-database-setup</story-id>
    <epic>1</epic>
    <epic-name>Foundation and Core Chat</epic-name>
    <status>ready-for-dev</status>
    <generated>2026-01-15</generated>
    <story-file>./thoughts/implementation-artifacts/stories/story-1-4-sqlite-database-setup.md</story-file>
    <atdd-checklist>./thoughts/implementation-artifacts/stories/atdd-checklist-1-4-sqlite-database-setup.md</atdd-checklist>
  </metadata>

  <story>
    <title>SQLite Database Setup</title>
    <user-story>
      As a user,
      I want my data stored locally on my device,
      So that my information stays private and under my control.
    </user-story>

    <acceptance-criteria>
      <criterion id="AC1" name="Database File Creation">
        <given>the app launches for the first time</given>
        <when>initialization completes</when>
        <then>SQLite database is created at ~/Library/Application Support/Orion/orion.db (ARCH-007)</then>
        <and>the parent directory is created if it doesn't exist</and>
        <and>the database file has appropriate permissions (user read/write only)</and>
      </criterion>

      <criterion id="AC2" name="WAL Mode Enabled">
        <given>the database is initialized</given>
        <when>any database operation occurs</when>
        <then>WAL (Write-Ahead Logging) mode is enabled for concurrent reads (ARCH-008)</then>
        <and>PRAGMA journal_mode returns 'wal'</and>
        <and>cache size is set to 64MB for performance (PRAGMA cache_size=-64000)</and>
      </criterion>

      <criterion id="AC3" name="Core Schema - Conversations Table">
        <given>the database is initialized</given>
        <when>I query the schema</when>
        <then>the conversations table exists with all required columns</then>
        <columns>
          <column name="id" type="TEXT PRIMARY KEY" format="conv_xxx"/>
          <column name="sdk_session_id" type="TEXT" description="Claude SDK session ID"/>
          <column name="title" type="TEXT"/>
          <column name="summary" type="TEXT"/>
          <column name="project_id" type="TEXT" fk="projects"/>
          <column name="area_id" type="TEXT" fk="areas"/>
          <column name="message_count" type="INTEGER" default="0"/>
          <column name="tool_call_count" type="INTEGER" default="0"/>
          <column name="is_active" type="INTEGER" default="1"/>
          <column name="is_pinned" type="INTEGER" default="0"/>
          <column name="tags" type="TEXT" json="array"/>
          <column name="metadata" type="TEXT" json="object"/>
          <column name="started_at" type="TEXT" default="datetime('now')"/>
          <column name="last_message_at" type="TEXT"/>
          <column name="archived_at" type="TEXT"/>
        </columns>
      </criterion>

      <criterion id="AC4" name="Core Schema - Messages Table">
        <given>the database is initialized</given>
        <when>I query the schema</when>
        <then>the messages table exists with all required columns</then>
        <columns>
          <column name="id" type="TEXT PRIMARY KEY" format="msg_xxx"/>
          <column name="conversation_id" type="TEXT NOT NULL" fk="conversations" on-delete="CASCADE"/>
          <column name="role" type="TEXT NOT NULL" check="user | assistant | system"/>
          <column name="content" type="TEXT NOT NULL"/>
          <column name="tool_calls" type="TEXT" json="array"/>
          <column name="tool_results" type="TEXT" json="array"/>
          <column name="input_tokens" type="INTEGER"/>
          <column name="output_tokens" type="INTEGER"/>
          <column name="feedback" type="TEXT" check="thumbs_up | thumbs_down | NULL"/>
          <column name="feedback_note" type="TEXT"/>
          <column name="metadata" type="TEXT" json="object"/>
          <column name="created_at" type="TEXT" default="datetime('now')"/>
        </columns>
        <indexes>
          <index name="idx_messages_conversation" columns="conversation_id, created_at"/>
        </indexes>
      </criterion>

      <criterion id="AC5" name="Data Persistence">
        <given>the database exists with data</given>
        <when>the app launches again</when>
        <then>existing data is preserved</then>
        <and>no data is lost or corrupted</and>
      </criterion>

      <criterion id="AC6" name="Schema Migrations">
        <given>the database exists</given>
        <when>the app launches with a newer schema version</when>
        <then>migrations run automatically and idempotently</then>
        <and>existing data is preserved during migrations</and>
        <and>migration version is tracked in a schema_version metadata</and>
      </criterion>

      <criterion id="AC7" name="Foreign Keys Enforced">
        <given>the database is initialized</given>
        <when>any database operation occurs</when>
        <then>PRAGMA foreign_keys returns 1 (enabled)</then>
        <and>invalid foreign key references are rejected</and>
      </criterion>
    </acceptance-criteria>
  </story>

  <atdd-summary>
    <total-tests>
      <unit-tests>25</unit-tests>
      <integration-tests>13</integration-tests>
      <e2e-tests>2</e2e-tests>
    </total-tests>

    <test-coverage>
      <ac id="AC1" unit="3" integration="2" e2e="1"/>
      <ac id="AC2" unit="2" integration="2" e2e="0"/>
      <ac id="AC3" unit="5" integration="1" e2e="0"/>
      <ac id="AC4" unit="5" integration="1" e2e="0"/>
      <ac id="AC5" unit="2" integration="3" e2e="1"/>
      <ac id="AC6" unit="5" integration="2" e2e="0"/>
      <ac id="AC7" unit="3" integration="2" e2e="0"/>
    </test-coverage>

    <key-test-patterns>
      <pattern name="in-memory-db">Use Database(':memory:') for fast unit tests</pattern>
      <pattern name="file-db">Use temp directory for integration tests</pattern>
      <pattern name="cleanup">Always close database and remove temp files after tests</pattern>
      <pattern name="fk-enabled">Always enable foreign_keys pragma in tests</pattern>
    </key-test-patterns>

    <definition-of-done>
      <item>All unit tests pass (25 tests)</item>
      <item>All integration tests pass (13 tests)</item>
      <item>All E2E tests pass (2 tests)</item>
      <item>Test coverage greater than 80% for src/lib/db/**</item>
      <item>No flaky tests identified</item>
      <item>Tests run in less than 30 seconds (unit + integration)</item>
    </definition-of-done>
  </atdd-summary>

  <architecture-patterns>
    <constraint id="ARCH-007" name="Database Location">
      <path>~/Library/Application Support/Orion/orion.db</path>
      <description>Local-first data storage on user's device</description>
    </constraint>

    <constraint id="ARCH-008" name="WAL Mode">
      <pragma>journal_mode=WAL</pragma>
      <description>Write-Ahead Logging for concurrent reads and crash recovery</description>
    </constraint>

    <constraint id="NFR-S001" name="Local-First Architecture">
      <description>Data stays on device for privacy</description>
    </constraint>

    <pragmas required="true">
      <pragma>journal_mode=WAL</pragma>
      <pragma>foreign_keys=ON</pragma>
      <pragma>cache_size=-64000</pragma>
    </pragmas>

    <database-library>
      <name>better-sqlite3</name>
      <version>11.x</version>
      <types>@types/better-sqlite3</types>
      <rationale>Synchronous API, better performance for desktop apps, native bindings</rationale>
    </database-library>

    <id-format-convention>
      <entity prefix="conv_" example="conv_abc123xyz">Conversation</entity>
      <entity prefix="msg_" example="msg_def456uvw">Message</entity>
      <entity prefix="cont_" example="cont_ghi789rst">Contact</entity>
      <entity prefix="proj_" example="proj_jkl012mno">Project</entity>
      <entity prefix="task_" example="task_pqr345stu">Task</entity>
    </id-format-convention>

    <schema-from-architecture>
      <!--
        conversations table schema from architecture.md Section 4.1
        This is the authoritative schema definition
      -->
      <table name="conversations">
        <sql><![CDATA[
CREATE TABLE conversations (
    id TEXT PRIMARY KEY,                     -- conv_xxx format
    sdk_session_id TEXT,                     -- Claude SDK session ID
    title TEXT,
    summary TEXT,

    -- Context
    project_id TEXT REFERENCES projects(id),
    area_id TEXT REFERENCES areas(id),

    -- Stats
    message_count INTEGER DEFAULT 0,
    tool_call_count INTEGER DEFAULT 0,

    -- State
    is_active INTEGER DEFAULT 1,
    is_pinned INTEGER DEFAULT 0,

    tags TEXT,
    metadata TEXT,

    started_at TEXT DEFAULT (datetime('now')),
    last_message_at TEXT,
    archived_at TEXT
);

CREATE INDEX idx_conversations_active ON conversations(is_active, last_message_at DESC);
        ]]></sql>
      </table>

      <table name="messages">
        <sql><![CDATA[
CREATE TABLE messages (
    id TEXT PRIMARY KEY,                     -- msg_xxx format
    conversation_id TEXT NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    role TEXT NOT NULL,                      -- user | assistant | system
    content TEXT NOT NULL,

    -- Tool use
    tool_calls TEXT,                         -- JSON array
    tool_results TEXT,                       -- JSON array

    -- Tokens
    input_tokens INTEGER,
    output_tokens INTEGER,

    -- Feedback
    feedback TEXT,                           -- thumbs_up | thumbs_down
    feedback_note TEXT,

    metadata TEXT,
    created_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at);
        ]]></sql>
        <note>Add CHECK constraints for role and feedback enum-like fields</note>
      </table>
    </schema-from-architecture>
  </architecture-patterns>

  <implementation-guide>
    <directory-structure>
      <path>src/lib/db/index.ts</path>
      <description>Database initialization and singleton</description>

      <path>src/lib/db/path.ts</path>
      <description>Database path utilities</description>

      <path>src/lib/db/ids.ts</path>
      <description>ID generation utilities</description>

      <path>src/lib/db/types.ts</path>
      <description>TypeScript type definitions</description>

      <path>src/lib/db/migrations/index.ts</path>
      <description>Migration runner</description>

      <path>src/lib/db/migrations/001_initial.ts</path>
      <description>Initial schema migration</description>

      <path>src/lib/db/repositories/conversations.ts</path>
      <description>Conversation CRUD</description>

      <path>src/lib/db/repositories/messages.ts</path>
      <description>Message CRUD</description>
    </directory-structure>

    <test-structure>
      <path>tests/unit/db/setup.ts</path>
      <description>Test database setup helpers</description>

      <path>tests/unit/db/migrations.test.ts</path>
      <description>Migration tests</description>

      <path>tests/unit/db/conversations.test.ts</path>
      <description>Conversation repository tests</description>

      <path>tests/unit/db/messages.test.ts</path>
      <description>Message repository tests</description>

      <path>tests/integration/db/persistence.test.ts</path>
      <description>Data persistence tests</description>

      <path>tests/integration/db/pragmas.test.ts</path>
      <description>SQLite pragma verification</description>
    </test-structure>

    <dependencies>
      <dependency name="better-sqlite3" version="^11.0.0" type="runtime"/>
      <dependency name="@types/better-sqlite3" version="^7.6.0" type="dev"/>
    </dependencies>

    <critical-tasks>
      <task priority="1">
        Task 1: Database Path and Directory Setup (AC1)
        - getDatabasePath() returning ~/Library/Application Support/Orion/orion.db
        - Create directory if not exists
        - Set permissions (0o700 for dir, 0o600 for file)
        - Cross-platform fallback for development
      </task>

      <task priority="2">
        Task 2: Database Initialization Module (AC1, AC2, AC7)
        - Install better-sqlite3 and types
        - Singleton pattern for database instance
        - Enable WAL mode, foreign keys, cache size
        - Run migrations on init
        - Graceful close on shutdown
      </task>

      <task priority="3">
        Task 3: Schema Version Tracking (AC6)
        - Create schema_version table
        - Track version, applied_at, description
        - Get/set current version functions
      </task>

      <task priority="4">
        Task 4: Migration Framework (AC6)
        - Migration interface with version, description, up()
        - Migration runner executing in order
        - Transactions per migration
        - Idempotent execution
      </task>

      <task priority="5">
        Task 5: Initial Migration (AC3, AC4)
        - Create conversations table with all columns
        - Create messages table with FK and CHECK constraints
        - Create required indexes
      </task>

      <task priority="6">
        Task 6: ID Generation Utilities
        - generateId(prefix) with crypto.randomBytes
        - generateConversationId() and generateMessageId()
        - URL-safe, unique IDs
      </task>

      <task priority="7">
        Task 7: TypeScript Types
        - Conversation and Message interfaces
        - MessageRole and MessageFeedback types
        - Type guards for JSON fields
      </task>

      <task priority="8">
        Task 8: Repository CRUD Operations
        - createConversation, getConversation, updateConversation, listConversations
        - createMessage, getMessages, getMessage
        - Use prepared statements
      </task>

      <task priority="9">
        Task 9: Tauri Integration (AC1, AC5)
        - Initialize database on app startup
        - Close database on app quit
        - Ensure initialization before frontend loads
      </task>

      <task priority="10">
        Task 10: Unit Tests
        - Test all ACs with in-memory database
        - Test path resolution, pragmas, migrations, CRUD, cascade delete
      </task>

      <task priority="11">
        Task 11: Integration Tests
        - Test with file-based database
        - Test data persistence across restarts
        - Test WAL auxiliary files creation
      </task>
    </critical-tasks>
  </implementation-guide>

  <dependencies>
    <depends-on story="1-1-tauri-desktop-shell" reason="Provides app support directory"/>
    <parallel-with story="1-3-design-system-foundation"/>
    <enables story="1-6-chat-message-storage" reason="Database foundation"/>
    <enables story="1-5-agent-server-process" reason="May need database access"/>
  </dependencies>

  <technical-notes>
    <note topic="WAL Mode Benefits">
      - Allows concurrent reads while writing
      - Better crash recovery
      - Faster for most workloads
      - Creates additional files: orion.db-wal, orion.db-shm
    </note>

    <note topic="Migration Strategy">
      - Migrations numbered sequentially (001, 002, etc.)
      - Each migration runs in a transaction
      - Migrations are idempotent - safe to run multiple times
      - Version tracked in schema_version table
    </note>

    <note topic="Type Safety">
      - Use Zod schemas for runtime validation of JSON fields
      - TypeScript types for compile-time safety
      - Prepared statements prevent SQL injection
    </note>

    <note topic="Performance">
      - Use prepared statements for repeated queries
      - Index frequently queried columns
      - 64MB cache size for in-memory performance
      - WAL mode for concurrent access
    </note>

    <note topic="Error Handling">
      - Wrap database operations in try-catch
      - Log errors with context for debugging
      - Graceful degradation if database unavailable
    </note>
  </technical-notes>

  <references>
    <reference source="architecture.md" section="4.1">SQLite Schema (Local Data)</reference>
    <reference source="architecture.md" section="1.3">Key Design Decisions</reference>
    <reference source="architecture.md" constraint="ARCH-007">Database Location</reference>
    <reference source="architecture.md" constraint="ARCH-008">WAL Mode</reference>
    <reference source="prd.md" section="6.3">Database Architecture</reference>
    <reference source="prd.md" constraint="NFR-S001">Local-First Architecture</reference>
  </references>
</story-context>
