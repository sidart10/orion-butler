<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context Document for DEV Agent
  Story ID: 1-2-nextjs-frontend-integration
  Epic: 1 - Foundation & First Chat
  Generated: 2026-01-15
  Author: SM Agent (Bob)
-->
<story-context version="1.0">

  <!-- ============================================================ -->
  <!-- STORY OVERVIEW -->
  <!-- ============================================================ -->
  <story id="1-2-nextjs-frontend-integration" epic="1">
    <title>Next.js Frontend Integration</title>
    <status>ready-for-dev</status>

    <user-story>
      As a user,
      I want the app to display a modern React interface,
      So that I have a responsive and familiar web-like experience.
    </user-story>

    <dependency>
      <story-id>1-1-tauri-desktop-shell</story-id>
      <reason>Tauri shell must be running for WebView to load frontend</reason>
    </dependency>

    <enables>
      <story-id>1-3-design-system-foundation</story-id>
      <story-id>1-4-sqlite-database-setup</story-id>
      <story-id>1-9-split-screen-layout</story-id>
    </enables>
  </story>

  <!-- ============================================================ -->
  <!-- ACCEPTANCE CRITERIA -->
  <!-- ============================================================ -->
  <acceptance-criteria>

    <criterion id="AC1" priority="P0">
      <name>Frontend Loads in WebView</name>
      <given>the Tauri shell is running (Story 1.1 complete)</given>
      <when>the app initializes</when>
      <then>
        <requirement>the Next.js frontend loads in the webview</requirement>
        <requirement>React components render without hydration errors</requirement>
        <requirement>the frontend communicates with Tauri via IPC</requirement>
      </then>
    </criterion>

    <criterion id="AC2" priority="P0">
      <name>Error Boundary Protection</name>
      <given>there is a JavaScript error in the frontend</given>
      <when>the error occurs</when>
      <then>
        <requirement>it is caught and logged (not silent failure)</requirement>
        <requirement>the app remains functional</requirement>
        <requirement>user sees a friendly error message with recovery option</requirement>
      </then>
    </criterion>

    <criterion id="AC3" priority="P1">
      <name>Development Hot Reload</name>
      <given>the app is running in development mode</given>
      <when>I modify a React component</when>
      <then>
        <requirement>changes appear without full page reload</requirement>
        <requirement>component state is preserved where possible</requirement>
      </then>
    </criterion>

    <criterion id="AC4" priority="P0">
      <name>Production Build</name>
      <given>the app is built for production</given>
      <when>the build completes</when>
      <then>
        <requirement>Next.js outputs static files for Tauri</requirement>
        <requirement>no server-side rendering dependencies remain</requirement>
        <requirement>all assets are bundled correctly</requirement>
      </then>
    </criterion>

  </acceptance-criteria>

  <!-- ============================================================ -->
  <!-- IMPLEMENTATION TASKS -->
  <!-- ============================================================ -->
  <tasks>

    <task id="1" name="Next.js 14 App Router Setup" acs="AC1,AC3,AC4">
      <subtasks>
        <subtask id="1.1">Initialize Next.js 14 with App Router in project root</subtask>
        <subtask id="1.2">Configure next.config.js for static export (output: 'export')</subtask>
        <subtask id="1.3">Set up TypeScript configuration (tsconfig.json)</subtask>
        <subtask id="1.4">Configure path aliases (@/ for src/)</subtask>
        <subtask id="1.5">Add pnpm scripts: dev, build, lint</subtask>
      </subtasks>
    </task>

    <task id="2" name="Tauri-Next.js Integration" acs="AC1,AC3">
      <subtasks>
        <subtask id="2.1">Update tauri.conf.json: devUrl to http://localhost:3000, frontendDist to ../out</subtask>
        <subtask id="2.2">Add @tauri-apps/api package for frontend IPC</subtask>
        <subtask id="2.3">Create src/lib/tauri.ts with IPC helper functions</subtask>
        <subtask id="2.4">Implement basic IPC test: invoke('greet') command</subtask>
        <subtask id="2.5">Add Rust greet command in src-tauri/src/main.rs for testing</subtask>
      </subtasks>
    </task>

    <task id="3" name="Root Layout and Page Structure" acs="AC1">
      <subtasks>
        <subtask id="3.1">Create src/app/layout.tsx with HTML lang, font preloading (Inter, Playfair Display), viewport meta</subtask>
        <subtask id="3.2">Create src/app/page.tsx with placeholder content</subtask>
        <subtask id="3.3">Create src/app/globals.css with minimal reset styles</subtask>
        <subtask id="3.4">Add src/app/loading.tsx for loading states</subtask>
      </subtasks>
    </task>

    <task id="4" name="Error Boundary Implementation" acs="AC2">
      <subtasks>
        <subtask id="4.1">Create src/components/error-boundary.tsx with React Error Boundary, fallback UI, Try Again button</subtask>
        <subtask id="4.2">Create src/app/error.tsx (Next.js App Router error page)</subtask>
        <subtask id="4.3">Create src/app/global-error.tsx for root-level errors</subtask>
        <subtask id="4.4">Add error context provider for centralized error handling</subtask>
        <subtask id="4.5">Test error boundary with deliberate throw</subtask>
      </subtasks>
    </task>

    <task id="5" name="Tauri IPC Communication" acs="AC1">
      <subtasks>
        <subtask id="5.1">Create src/lib/tauri.ts with typed invoke wrapper</subtask>
        <subtask id="5.2">Implement event listener setup (listen from @tauri-apps/api)</subtask>
        <subtask id="5.3">Create src/hooks/useTauriEvent.ts custom hook</subtask>
        <subtask id="5.4">Test bidirectional IPC (invoke and emit)</subtask>
        <subtask id="5.5">Add IPC status indicator in dev mode</subtask>
      </subtasks>
    </task>

    <task id="6" name="Build Configuration for Tauri" acs="AC4">
      <subtasks>
        <subtask id="6.1">Configure next.config.js: output export, distDir out, images.unoptimized true, trailingSlash true</subtask>
        <subtask id="6.2">Update package.json scripts: tauri:dev, tauri:build</subtask>
        <subtask id="6.3">Test production build: verify out/ directory structure</subtask>
        <subtask id="6.4">Verify assets load correctly in built app</subtask>
      </subtasks>
    </task>

    <task id="7" name="Development Workflow" acs="AC3">
      <subtasks>
        <subtask id="7.1">Configure concurrent dev scripts (Next.js dev server at port 3000)</subtask>
        <subtask id="7.2">Test HMR (Hot Module Replacement) works</subtask>
        <subtask id="7.3">Verify component state preserves on edit</subtask>
        <subtask id="7.4">Document development workflow in README</subtask>
      </subtasks>
    </task>

    <task id="8" name="Testing Setup" acs="AC1,AC2">
      <subtasks>
        <subtask id="8.1">Verify no React hydration errors in console</subtask>
        <subtask id="8.2">Test IPC invoke works bidirectionally</subtask>
        <subtask id="8.3">Test error boundary catches thrown errors</subtask>
        <subtask id="8.4">Verify hot reload in development mode</subtask>
      </subtasks>
    </task>

  </tasks>

  <!-- ============================================================ -->
  <!-- ARCHITECTURE PATTERNS -->
  <!-- ============================================================ -->
  <architecture>

    <constraints>
      <constraint source="architecture.md#3.1">
        <name>Frontend Framework</name>
        <requirement>Next.js 14</requirement>
      </constraint>
      <constraint source="architecture.md#1.3">
        <name>Static Export</name>
        <requirement>Required for Tauri - no SSR</requirement>
      </constraint>
      <constraint source="architecture.md#2.2">
        <name>IPC Protocol</name>
        <requirement>Tauri invoke/events</requirement>
      </constraint>
      <constraint source="architecture.md#3.2">
        <name>TypeScript</name>
        <requirement>Required</requirement>
      </constraint>
      <constraint source="architecture.md#3.2">
        <name>Package Manager</name>
        <requirement>pnpm</requirement>
      </constraint>
    </constraints>

    <static-export-config>
      <![CDATA[
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',           // Static HTML export
  distDir: 'out',             // Output to 'out' for Tauri
  images: {
    unoptimized: true,        // Required for static export
  },
  trailingSlash: true,        // Required for file:// protocol
  // FORBIDDEN (no server-side features):
  // - No API routes
  // - No Server Components with async data fetching
  // - No middleware
  // - No ISR/SSR
}

module.exports = nextConfig
      ]]>
    </static-export-config>

    <tauri-config>
      <![CDATA[
// src-tauri/tauri.conf.json (relevant sections)
{
  "build": {
    "beforeBuildCommand": "pnpm build",
    "beforeDevCommand": "pnpm dev",
    "frontendDist": "../out",
    "devUrl": "http://localhost:3000"
  },
  "app": {
    "windows": [{
      "title": "Orion",
      "width": 1400,
      "height": 900,
      "minWidth": 1000,
      "minHeight": 700,
      "titleBarStyle": "Overlay"
    }]
  }
}
      ]]>
    </tauri-config>

    <ipc-pattern>
      <![CDATA[
// src/lib/tauri.ts
import { invoke, listen } from '@tauri-apps/api';

// Frontend -> Backend (invoke)
export async function greet(name: string): Promise<string> {
  return invoke<string>('greet', { name });
}

// Backend -> Frontend (events)
export function onBackendEvent(callback: (payload: unknown) => void) {
  return listen('backend-event', (event) => callback(event.payload));
}

// Rust side (src-tauri/src/main.rs)
#[tauri::command]
fn greet(name: &str) -> String {
    format!("Hello, {}! Welcome to Orion.", name)
}
      ]]>
    </ipc-pattern>

    <error-boundary-pattern>
      <![CDATA[
// src/components/error-boundary.tsx
'use client';

import { Component, ErrorInfo, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('[ErrorBoundary] Caught error:', {
      error: error.message,
      stack: error.stack,
      componentStack: errorInfo.componentStack,
      timestamp: new Date().toISOString(),
    });
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="error-container">
          <h2>Something went wrong</h2>
          <button onClick={() => this.setState({ hasError: false, error: null })}>
            Try Again
          </button>
        </div>
      );
    }
    return this.props.children;
  }
}
      ]]>
    </error-boundary-pattern>

    <frontend-structure>
      <![CDATA[
src/
├── app/
│   ├── layout.tsx         # CREATE: Root layout with fonts
│   ├── page.tsx           # CREATE: Home page (placeholder)
│   ├── loading.tsx        # CREATE: Loading state
│   ├── error.tsx          # CREATE: Error page
│   ├── global-error.tsx   # CREATE: Global error handler
│   └── globals.css        # CREATE: Global styles
├── components/
│   └── error-boundary.tsx # CREATE: Error boundary component
├── hooks/
│   └── useTauriEvent.ts   # CREATE: Tauri event hook
└── lib/
    └── tauri.ts           # CREATE: Tauri IPC helpers
      ]]>
    </frontend-structure>

    <design-system-fonts>
      <![CDATA[
<!-- Required fonts for Orion Design System -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

Font Usage:
- Playfair Display: Headlines, quotes, emphasis (serif)
- Inter: Body text, labels, UI (sans-serif)
      ]]>
    </design-system-fonts>

  </architecture>

  <!-- ============================================================ -->
  <!-- TECHNICAL NOTES -->
  <!-- ============================================================ -->
  <technical-notes>

    <note category="static-export-limitations">
      <title>Static Export Limitations</title>
      <items>
        <item>No getServerSideProps or getStaticProps with revalidate</item>
        <item>No API routes (/api/*) - use Tauri commands instead</item>
        <item>No Image Optimization API - use unoptimized: true</item>
        <item>All data fetching must be client-side or build-time</item>
      </items>
    </note>

    <note category="hydration-prevention">
      <title>Hydration Error Prevention</title>
      <items>
        <item>Avoid Date.now() or random values in initial render</item>
        <item>Use useEffect for browser-only code</item>
        <item>Wrap browser APIs with typeof window !== 'undefined' checks</item>
        <item>Tauri APIs must be called client-side only</item>
      </items>
    </note>

    <note category="ipc-best-practices">
      <title>IPC Best Practices</title>
      <items>
        <item>Always type IPC payloads with TypeScript</item>
        <item>Handle IPC errors gracefully (Tauri not available in browser)</item>
        <item>Use try/catch around all invoke calls</item>
        <item>Clean up event listeners on component unmount</item>
      </items>
    </note>

    <note category="dev-vs-prod">
      <title>Development vs Production</title>
      <items>
        <item>Dev: Next.js dev server at localhost:3000, Tauri loads URL</item>
        <item>Prod: Static export to out/, Tauri bundles files</item>
      </items>
    </note>

  </technical-notes>

  <!-- ============================================================ -->
  <!-- DEPENDENCIES -->
  <!-- ============================================================ -->
  <dependencies>

    <production>
      <package name="next" version="14" />
      <package name="react" version="18" />
      <package name="react-dom" version="18" />
      <package name="@tauri-apps/api" version="2" />
    </production>

    <development>
      <package name="typescript" />
      <package name="@types/react" />
      <package name="@types/react-dom" />
      <package name="@types/node" />
      <package name="eslint" />
      <package name="eslint-config-next" />
      <package name="prettier" />
    </development>

    <install-commands>
      <![CDATA[
# Next.js and React
pnpm add next@14 react@18 react-dom@18

# Tauri API for frontend
pnpm add @tauri-apps/api@2

# TypeScript types
pnpm add -D typescript @types/react @types/react-dom @types/node

# Development tools
pnpm add -D eslint eslint-config-next prettier
      ]]>
    </install-commands>

  </dependencies>

  <!-- ============================================================ -->
  <!-- ATDD CHECKLIST SUMMARY -->
  <!-- ============================================================ -->
  <atdd-reference file="atdd-checklist-1-2-nextjs-frontend-integration.md">
    <summary>
      <test-distribution>
        <level type="unit" count="8" coverage="30%" />
        <level type="integration" count="10" coverage="37%" />
        <level type="e2e" count="9" coverage="33%" />
        <total count="27" />
      </test-distribution>

      <key-tests priority="P0">
        <test id="AC1-01">Frontend renders in Tauri WebView</test>
        <test id="AC1-02">No React hydration errors</test>
        <test id="AC1-03">No console errors on initial load</test>
        <test id="AC1-04">IPC invoke command works (frontend to backend)</test>
        <test id="AC1-08">Tauri API available in window context</test>
        <test id="AC2-01">ErrorBoundary catches render errors</test>
        <test id="AC2-02">ErrorBoundary logs errors with structure</test>
        <test id="AC2-03">Try Again button resets error state</test>
        <test id="AC4-01">Build completes without errors</test>
        <test id="AC4-02">Static export generates out/ directory</test>
        <test id="AC4-07">Built app runs in Tauri</test>
      </key-tests>

      <acceptance-gate>
        <criterion>All P0 tests passing: 100% (11 tests)</criterion>
        <criterion>All P1 tests passing: 100% (11 tests)</criterion>
        <criterion>No console errors in E2E: 0 critical errors</criterion>
        <criterion>Build completes: Exit code 0</criterion>
        <criterion>Production loads in Tauri: Page renders</criterion>
      </acceptance-gate>
    </summary>
  </atdd-reference>

  <!-- ============================================================ -->
  <!-- FILE MANIFEST -->
  <!-- ============================================================ -->
  <file-manifest>
    <files-to-create>
      <file path="src/app/layout.tsx" purpose="Root layout with fonts and meta" />
      <file path="src/app/page.tsx" purpose="Home page placeholder" />
      <file path="src/app/loading.tsx" purpose="Loading state" />
      <file path="src/app/error.tsx" purpose="Route error page" />
      <file path="src/app/global-error.tsx" purpose="Global error handler" />
      <file path="src/app/globals.css" purpose="Global styles" />
      <file path="src/components/error-boundary.tsx" purpose="Error boundary component" />
      <file path="src/hooks/useTauriEvent.ts" purpose="Tauri event hook" />
      <file path="src/lib/tauri.ts" purpose="Tauri IPC helpers" />
      <file path="next.config.js" purpose="Next.js configuration" />
      <file path="tsconfig.json" purpose="TypeScript configuration" />
    </files-to-create>

    <files-to-modify>
      <file path="src-tauri/tauri.conf.json" purpose="Configure build paths" />
      <file path="src-tauri/src/main.rs" purpose="Add greet command" />
      <file path="package.json" purpose="Add dependencies and scripts" />
    </files-to-modify>
  </file-manifest>

  <!-- ============================================================ -->
  <!-- VERIFICATION COMMANDS -->
  <!-- ============================================================ -->
  <verification>
    <command purpose="development-server">pnpm dev</command>
    <command purpose="tauri-dev">pnpm tauri dev</command>
    <command purpose="production-build">pnpm build</command>
    <command purpose="tauri-build">pnpm tauri build</command>
    <command purpose="lint">pnpm lint</command>
    <command purpose="type-check">pnpm tsc --noEmit</command>
    <command purpose="verify-output">ls -la out/</command>
  </verification>

</story-context>
