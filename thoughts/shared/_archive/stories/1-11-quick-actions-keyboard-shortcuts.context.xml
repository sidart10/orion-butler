<?xml version="1.0" encoding="UTF-8"?>
<story-context id="1-11-quick-actions-keyboard-shortcuts" epic="1">
  <metadata>
    <created>2026-01-15T18:20:00Z</created>
    <status>ready-for-dev</status>
    <story-file>1-11-quick-actions-keyboard-shortcuts.context.xml</story-file>
    <atdd-checklist>atdd-checklist-1-11-quick-actions-keyboard-shortcuts.md</atdd-checklist>
    <priority>P2</priority>
    <risk>LOW</risk>
  </metadata>

  <story>
    <overview>
      As a power user, I want keyboard shortcuts and suggested actions,
      so that I can work efficiently without reaching for the mouse.

      This story implements the keyboard-first productivity experience that power users expect,
      including Cmd+Enter to send messages, Cmd+K command palette, quick action chips after
      AI responses, and accessible keyboard hints throughout the UI.
    </overview>

    <acceptance-criteria>
      <criterion id="AC1" feature="FR-CH006">
        Cmd+Enter Sends Message - When focused in chat input and pressing Cmd+Enter (Mac) or Ctrl+Enter (fallback), the message sends immediately, input clears, and focus remains in input field.
      </criterion>
      <criterion id="AC2" feature="FR-CH006">
        Cmd+K Opens Command Palette - Pressing Cmd+K anywhere in the app opens a modal command palette with search input focused. Palette shows available commands filtered in real-time.
      </criterion>
      <criterion id="AC3" feature="FR-CH005">
        Quick Action Chips After Response - When Claude's response completes with suggested actions, clickable chips appear below the message. Clicking a chip triggers the associated action (pre-fills input or navigates).
      </criterion>
      <criterion id="AC4">
        Command Palette Real-time Filtering - Typing in command palette filters commands instantly (within 50ms). Commands show name, description, and keyboard shortcut hint.
      </criterion>
      <criterion id="AC5">
        Command Palette Keyboard Navigation - Arrow keys navigate filtered results, Enter selects highlighted command, Escape closes palette returning focus to previous element.
      </criterion>
      <criterion id="AC6">
        Global Keyboard Shortcuts - Implement: Cmd+/ toggle sidebar, Cmd+N new chat, ? help overlay, Esc close/cancel. All shortcuts work globally except when in text input (then only Escape works).
      </criterion>
      <criterion id="AC7">
        Keyboard Hint Display - Buttons and actions show keyboard shortcut hints via tooltips (on hover) and aria-label attributes. Help overlay (?) shows complete shortcut reference.
      </criterion>
      <criterion id="AC8">
        Accessibility Compliance - All shortcuts have visible hints, focus management is correct, screen reader announces palette open/close, Enter/Space activates any interactive element.
      </criterion>
      <criterion id="AC9">
        Quick Action Chip Design - Chips follow Orion Design System: sharp corners, gold border on hover, cream background, Inter font at 13px, 8px horizontal padding.
      </criterion>
      <criterion id="AC10">
        Shortcut Conflict Prevention - Shortcuts don't conflict with browser defaults (Cmd+R, Cmd+T). Text inputs capture typing without triggering global shortcuts.
      </criterion>
    </acceptance-criteria>

    <dependencies>
      <dependency type="story">Story 1-2 (Next.js Frontend Integration) - provides React component foundation</dependency>
      <dependency type="story">Story 1-3 (Design System Foundation) - provides design tokens and component styles</dependency>
      <dependency type="story">Story 1-8 (Streaming Responses) - provides suggested_actions event type</dependency>
      <dependency type="story">Story 1-9 (Split-Screen Layout) - provides sidebar toggle infrastructure</dependency>
      <dependency type="library">cmdk or radix-ui/dialog - for command palette implementation</dependency>
      <dependency type="library">zustand - state management for palette open state</dependency>
      <dependency type="library">lucide-react - icons (Command, Search, ChevronRight, Keyboard)</dependency>
      <dependency type="library">framer-motion - animation for palette enter/exit (optional)</dependency>
    </dependencies>

    <technical-notes>
      <note category="shortcuts">Use useEffect with document-level keydown listener. Check event.metaKey (Mac) or event.ctrlKey (Windows) for modifier keys.</note>
      <note category="focus">Use ref-based focus management. Save previous activeElement before palette opens, restore on close.</note>
      <note category="filtering">Implement fuzzy search for command matching (simple includes or fuse.js for advanced).</note>
      <note category="stream-event">Listen for suggested_actions event type from stream with actions array.</note>
      <note category="accessibility">Use role="dialog", aria-modal="true", aria-labelledby for palette. Use role="listbox" for results.</note>
      <note category="conflict-prevention">Check document.activeElement.tagName to skip global shortcuts when in INPUT, TEXTAREA, or contenteditable.</note>
      <note category="storage">Persist recently used commands in localStorage for "Recent" section in palette.</note>
    </technical-notes>
  </story>

  <tests>
    <atdd-checklist-ref>atdd-checklist-1-11-quick-actions-keyboard-shortcuts.md</atdd-checklist-ref>
    <test-summary>
      <total-tests>52</total-tests>
      <by-type>
        <unit>18</unit>
        <integration>8</integration>
        <e2e>21</e2e>
        <accessibility>5</accessibility>
      </by-type>
    </test-summary>
    <test-locations>
      <location type="unit">tests/unit/hooks/useKeyboardShortcuts.test.ts</location>
      <location type="unit">tests/unit/components/CommandPalette.test.tsx</location>
      <location type="unit">tests/unit/components/QuickActionChip.test.tsx</location>
      <location type="unit">tests/unit/components/KeyboardHint.test.tsx</location>
      <location type="integration">tests/integration/keyboard-shortcuts.test.ts</location>
      <location type="e2e">tests/e2e/story-1.11-shortcuts.spec.ts</location>
      <location type="e2e">tests/e2e/command-palette.spec.ts</location>
      <location type="accessibility">tests/e2e/shortcuts-a11y.spec.ts</location>
    </test-locations>
    <gate-criteria>
      <criterion>All 52 tests pass</criterion>
      <criterion>Unit test coverage >= 80% for shortcut hooks and components</criterion>
      <criterion>E2E tests pass on macOS (Cmd key) and with Ctrl fallback</criterion>
      <criterion>Accessibility audit passes (axe-core)</criterion>
      <criterion>No shortcut conflicts with browser defaults</criterion>
      <criterion>Performance: Command palette opens in less than 100ms</criterion>
      <criterion>Code review approved</criterion>
      <criterion>No P0/P1 bugs open</criterion>
    </gate-criteria>
  </tests>

  <architecture>
    <relevant-sections>
      <section id="7.2" title="State Management">
        <content><![CDATA[
// Add to UI state store (new store or extend existing)
interface UIState {
  isCommandPaletteOpen: boolean;
  isSidebarOpen: boolean;
  isHelpOverlayOpen: boolean;

  // Actions
  toggleCommandPalette: () => void;
  toggleSidebar: () => void;
  toggleHelpOverlay: () => void;
}

// Command registry for palette
interface Command {
  id: string;
  name: string;
  description?: string;
  shortcut?: string;      // e.g., "Cmd+N"
  category: 'navigation' | 'action' | 'chat';
  action: () => void;
  icon?: React.ReactNode;
}
        ]]></content>
      </section>

      <section id="12.1" title="Streaming Events - Suggested Actions">
        <content><![CDATA[
// Add to stream event types
export interface SuggestedActionsEvent {
  type: 'suggested_actions';
  actions: SuggestedAction[];
}

export interface SuggestedAction {
  id: string;
  label: string;           // Display text
  action: 'prefill' | 'navigate' | 'execute';
  value?: string;          // Prefill text or URL
  icon?: string;           // Optional icon name
}

// Example from Claude response:
// data: {"type":"suggested_actions","actions":[
//   {"id":"sa_1","label":"Schedule meeting","action":"prefill","value":"Schedule a meeting with..."},
//   {"id":"sa_2","label":"Send email","action":"prefill","value":"Send an email to..."},
//   {"id":"sa_3","label":"Create task","action":"navigate","value":"/tasks/new"}
// ]}
        ]]></content>
      </section>

      <section id="UX-006" title="Keyboard Shortcuts Reference">
        <content><![CDATA[
// Global Shortcuts (from UX spec)
const GLOBAL_SHORTCUTS = {
  'Cmd+/': 'Toggle sidebar',
  'Cmd+K': 'Command palette',
  'Cmd+N': 'New chat',
  'Esc': 'Close/cancel/deselect',
  '?': 'Show keyboard help'
};

// Chat Shortcuts (from UX spec)
const CHAT_SHORTCUTS = {
  'j': 'Navigate down',
  'k': 'Navigate up',
  'Enter': 'Open selected item',
  'a': 'Archive',
  'r': 'Reply (opens canvas)',
  's': 'Schedule (opens canvas)',
  'd': 'Delegate',
  'u': 'Undo last action'
};

// Canvas Shortcuts
const CANVAS_SHORTCUTS = {
  'Esc': 'Close canvas',
  'Cmd+Enter': 'Submit/Send',
  'Tab': 'Next field',
  'Shift+Tab': 'Previous field'
};
        ]]></content>
      </section>
    </relevant-sections>

    <patterns-to-follow>
      <pattern name="Global Event Listener">useEffect with document.addEventListener for keydown, cleanup on unmount</pattern>
      <pattern name="Focus Trap">For command palette modal, trap focus inside using radix-ui FocusTrap or custom implementation</pattern>
      <pattern name="Controlled Input">Command palette search uses controlled input with immediate state updates</pattern>
      <pattern name="Command Pattern">Commands registered in central registry, actions executed via command.action()</pattern>
      <pattern name="Tooltip Pattern">Use radix-ui Tooltip or custom for keyboard hints on hover</pattern>
    </patterns-to-follow>

    <directory-structure>
      <file action="CREATE">src/hooks/useKeyboardShortcuts.ts</file>
      <file action="CREATE">src/hooks/useCommandPalette.ts</file>
      <file action="CREATE">src/components/CommandPalette.tsx</file>
      <file action="CREATE">src/components/CommandPaletteItem.tsx</file>
      <file action="CREATE">src/components/QuickActionChip.tsx</file>
      <file action="CREATE">src/components/QuickActionChipList.tsx</file>
      <file action="CREATE">src/components/KeyboardHint.tsx</file>
      <file action="CREATE">src/components/HelpOverlay.tsx</file>
      <file action="CREATE">src/stores/uiStore.ts - or extend existing store</file>
      <file action="CREATE">src/lib/commands.ts - command registry</file>
      <file action="MODIFY">src/components/chat/ChatInput.tsx - add Cmd+Enter handler</file>
      <file action="MODIFY">src/components/chat/ChatPanel.tsx - integrate quick action chips</file>
      <file action="MODIFY">src/components/layout/AppLayout.tsx - add global shortcut listener</file>
      <file action="CREATE">tests/unit/hooks/useKeyboardShortcuts.test.ts</file>
      <file action="CREATE">tests/e2e/story-1.11-shortcuts.spec.ts</file>
    </directory-structure>
  </architecture>

  <ux-context>
    <design-system-ref>thoughts/planning-artifacts/design-system-adoption.md</design-system-ref>
    <ux-spec-ref>thoughts/planning-artifacts/ux-design-specification.md</ux-spec-ref>

    <design-tokens>
      <token name="Chip Background" class="bg-orion-bg" value="#F9F8F6"/>
      <token name="Chip Border" class="border-orion-fg/10" value="#1A1A1A @ 10%"/>
      <token name="Chip Hover Border" class="border-orion-primary" value="#D4AF37"/>
      <token name="Chip Text" class="text-orion-fg" value="#1A1A1A"/>
      <token name="Chip Font" class="font-sans text-[13px]" value="Inter 13px"/>
      <token name="Chip Padding" class="px-3 py-1.5" value="12px 6px"/>
      <token name="Border Radius" value="0" note="Sharp corners, no radius"/>
      <token name="Palette Backdrop" class="bg-black/50" value="50% black overlay"/>
      <token name="Palette Background" class="bg-orion-bg" value="#F9F8F6"/>
      <token name="Palette Border" class="border-orion-fg/20" value="20% black border"/>
      <token name="Palette Width" value="560px max"/>
      <token name="Palette Animation" value="150ms ease-out scale from 95%"/>
      <token name="Shortcut Badge" class="bg-orion-fg/5 text-orion-fg/60 text-2xs font-mono" value="Light badge"/>
      <token name="Focus Ring" class="ring-2 ring-orion-primary ring-offset-2" value="Gold focus ring"/>
    </design-tokens>

    <component-anatomy>
      <component name="CommandPalette">
        <visual><![CDATA[
+----------------------------------------------------------+
| [Icon] Search commands...                          [Esc] |
+----------------------------------------------------------+
| Navigation                                               |
|   [>] New Chat                                   Cmd+N   |
|   [>] Toggle Sidebar                            Cmd+/   |
+----------------------------------------------------------+
| Actions                                                  |
|   [>] Reply to Email                               r     |
|   [>] Schedule Meeting                             s     |
+----------------------------------------------------------+
| Recent                                                   |
|   [>] Draft for Sarah (recent)                          |
+----------------------------------------------------------+
        ]]></visual>
      </component>

      <component name="QuickActionChips">
        <visual><![CDATA[
After assistant message:
+-----------------------------------------------+
|                                               |
| [ Schedule meeting ] [ Send email ] [ Create task ]
|                                               |
+-----------------------------------------------+
        ]]></visual>
      </component>

      <component name="KeyboardHint">
        <visual><![CDATA[
Button with hint:
+-------------------+
| Send  [Cmd+Enter] |   <- Hint badge
+-------------------+

Tooltip on hover:
        +-------------------+
        | Press Cmd+Enter   |
        | to send message   |
        +-------------------+
        ]]></visual>
      </component>

      <component name="HelpOverlay">
        <visual><![CDATA[
+----------------------------------------------------------+
| Keyboard Shortcuts                              [x]       |
+----------------------------------------------------------+
| Global                        | Chat                      |
|   Cmd+K    Command palette    |   j/k    Navigate        |
|   Cmd+N    New chat           |   Enter  Open            |
|   Cmd+/    Toggle sidebar     |   a      Archive         |
|   ?        This help          |   r      Reply           |
|   Esc      Close              |   s      Schedule        |
+----------------------------------------------------------+
        ]]></visual>
      </component>
    </component-anatomy>

    <interaction-patterns>
      <pattern name="Send Message">Cmd+Enter in input field triggers send, same as clicking Send button</pattern>
      <pattern name="Palette Open">Cmd+K shows palette with backdrop, focus moves to search input</pattern>
      <pattern name="Palette Navigate">Arrow Down/Up moves highlight, wraps around at ends</pattern>
      <pattern name="Palette Select">Enter executes highlighted command, closes palette</pattern>
      <pattern name="Palette Close">Escape closes palette, returns focus to previous element</pattern>
      <pattern name="Chip Click">Click executes chip action (prefill input or navigate)</pattern>
      <pattern name="Help Toggle">? key shows overlay, Escape or click outside closes</pattern>
    </interaction-patterns>
  </ux-context>

  <implementation-guidance>
    <task id="1" title="Create useKeyboardShortcuts Hook" priority="high">
      <files>src/hooks/useKeyboardShortcuts.ts</files>
      <description>
        Create a custom hook that:
        - Attaches global keydown listener on mount
        - Checks modifier keys (metaKey for Mac, ctrlKey fallback)
        - Skips shortcuts when focused in text inputs
        - Supports registering/unregistering shortcuts dynamically
        - Returns helper for checking if shortcut matches
      </description>
      <code-hint><![CDATA[
export function useKeyboardShortcuts(shortcuts: ShortcutMap) {
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      // Skip if in text input
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) {
        if (e.key !== 'Escape') return;
      }

      // Check for modifier + key combinations
      const key = getShortcutKey(e);
      if (shortcuts[key]) {
        e.preventDefault();
        shortcuts[key]();
      }
    };
    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [shortcuts]);
}
      ]]></code-hint>
      <acceptance-criteria>AC1, AC6, AC10</acceptance-criteria>
    </task>

    <task id="2" title="Create Command Registry" priority="high">
      <files>src/lib/commands.ts</files>
      <description>
        Create a command registry that:
        - Defines all available commands with metadata
        - Supports categories (navigation, action, chat)
        - Includes shortcut hints for display
        - Provides filter function for palette search
        - Tracks recently used commands in localStorage
      </description>
      <acceptance-criteria>AC4, AC7</acceptance-criteria>
    </task>

    <task id="3" title="Create CommandPalette Component" priority="high">
      <files>src/components/CommandPalette.tsx, src/components/CommandPaletteItem.tsx</files>
      <description>
        Create the command palette modal:
        - Modal with backdrop (50% black)
        - Search input with instant filtering
        - Grouped results by category
        - Keyboard navigation (arrows, enter, escape)
        - Focus trap inside palette
        - Animation on enter/exit (150ms scale)
        - Accessibility: dialog role, aria-modal, labelledby
      </description>
      <acceptance-criteria>AC2, AC4, AC5, AC8</acceptance-criteria>
    </task>

    <task id="4" title="Create QuickActionChip Components" priority="medium">
      <files>src/components/QuickActionChip.tsx, src/components/QuickActionChipList.tsx</files>
      <description>
        Create quick action chips:
        - Chip component with label and optional icon
        - ChipList container with horizontal layout
        - Click handler for prefill or navigate actions
        - Styling per Orion Design System
        - Keyboard accessible (Tab, Enter/Space)
      </description>
      <acceptance-criteria>AC3, AC9</acceptance-criteria>
    </task>

    <task id="5" title="Integrate Quick Actions with Streaming" priority="medium">
      <files>src/components/chat/ChatPanel.tsx</files>
      <description>
        Handle suggested_actions stream event:
        - Parse actions array from event
        - Store in chat store or local state
        - Render QuickActionChipList after message completes
        - Clear actions on new message
        - Handle prefill action (populate input)
        - Handle navigate action (router.push)
      </description>
      <acceptance-criteria>AC3</acceptance-criteria>
    </task>

    <task id="6" title="Add Cmd+Enter to Chat Input" priority="high">
      <files>src/components/chat/ChatInput.tsx</files>
      <description>
        Add keyboard handler to chat input:
        - Listen for Cmd+Enter (Mac) or Ctrl+Enter
        - Trigger send function (same as button click)
        - Prevent default behavior
        - Show keyboard hint badge next to send button
      </description>
      <acceptance-criteria>AC1</acceptance-criteria>
    </task>

    <task id="7" title="Create HelpOverlay Component" priority="medium">
      <files>src/components/HelpOverlay.tsx</files>
      <description>
        Create help modal triggered by ? key:
        - Modal with all keyboard shortcuts listed
        - Organized by context (Global, Chat, Canvas)
        - Close on Escape or click outside
        - Match Orion Design System styling
      </description>
      <acceptance-criteria>AC6, AC7</acceptance-criteria>
    </task>

    <task id="8" title="Create KeyboardHint Component" priority="low">
      <files>src/components/KeyboardHint.tsx</files>
      <description>
        Create reusable keyboard hint:
        - Badge component showing shortcut (e.g., "Cmd+K")
        - Tooltip wrapper for buttons with hint text
        - Consistent styling (2xs font, mono, light bg)
      </description>
      <acceptance-criteria>AC7</acceptance-criteria>
    </task>

    <task id="9" title="Integrate Global Shortcuts in Layout" priority="high">
      <files>src/components/layout/AppLayout.tsx</files>
      <description>
        Wire up global shortcuts at app level:
        - Cmd+K: toggle command palette
        - Cmd+N: create new chat
        - Cmd+/: toggle sidebar
        - ?: toggle help overlay
        - Esc: close any open modal/palette
      </description>
      <acceptance-criteria>AC2, AC6</acceptance-criteria>
    </task>

    <task id="10" title="Unit Tests for Hooks and Components" priority="high">
      <files>tests/unit/hooks/useKeyboardShortcuts.test.ts, tests/unit/components/CommandPalette.test.tsx</files>
      <description>
        Test coverage for:
        - Shortcut hook detects correct key combinations
        - Shortcuts skip when in text inputs (except Escape)
        - Command palette opens/closes correctly
        - Filtering updates results in real-time
        - Keyboard navigation highlights items correctly
        - Quick action chips trigger actions
      </description>
      <acceptance-criteria>All ACs</acceptance-criteria>
    </task>

    <task id="11" title="E2E Tests for Keyboard Interactions" priority="high">
      <files>tests/e2e/story-1.11-shortcuts.spec.ts</files>
      <description>
        Playwright tests for:
        - Cmd+Enter sends message
        - Cmd+K opens command palette
        - Arrow key navigation in palette
        - Quick action chips appear and are clickable
        - Help overlay shows on ? key
        - Shortcuts don't fire in input fields
      </description>
      <acceptance-criteria>All ACs</acceptance-criteria>
    </task>
  </implementation-guidance>

  <previous-story-learnings>
    <note story="1-10">framer-motion used for expand/collapse animations - can reuse for palette</note>
    <note story="1-8">Stream event handling pattern established in ChatPanel - follow for suggested_actions</note>
    <note story="1-9">Sidebar toggle state management exists - wire Cmd+/ to existing toggle action</note>
    <note story="1-3">Design tokens and Tailwind classes available - use orion- prefixed classes</note>
  </previous-story-learnings>

  <references>
    <reference type="epic">thoughts/planning-artifacts/epics.md#Story 1.11</reference>
    <reference type="prd">thoughts/planning-artifacts/prd.md (FR-CH005, FR-CH006)</reference>
    <reference type="architecture">thoughts/planning-artifacts/architecture.md#Section 7 - Frontend Architecture</reference>
    <reference type="test-design">thoughts/planning-artifacts/test-design-epic-1.md#Story 1.11</reference>
    <reference type="ux-spec">thoughts/planning-artifacts/ux-design-specification.md#Keyboard Patterns</reference>
    <reference type="design-system">thoughts/planning-artifacts/design-system-adoption.md</reference>
  </references>
</story-context>
