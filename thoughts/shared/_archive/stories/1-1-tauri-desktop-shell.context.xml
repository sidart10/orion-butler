<?xml version="1.0" encoding="UTF-8"?>
<story-context id="1-1-tauri-desktop-shell" epic="1">
  <metadata>
    <created>2026-01-15T00:00:00Z</created>
    <status>ready-for-dev</status>
    <story-file>story-1-1-tauri-desktop-shell.md</story-file>
    <atdd-file>atdd-checklist-1-1-tauri-desktop-shell.md</atdd-file>
  </metadata>

  <story>
    <title>Tauri Desktop Shell</title>
    <overview>
      As a user,
      I want to launch Orion as a native macOS application,
      So that I have a dedicated desktop experience for my AI butler.

      This is the foundation story - creates the Tauri shell that all other stories build upon.
    </overview>

    <acceptance-criteria>
      <criterion id="AC1" name="App Launch from Icon">
        <given>Orion is installed on macOS 12+</given>
        <when>I double-click the app icon or launch from Spotlight</when>
        <then>
          - The application window opens within 3 seconds
          - The window has correct dimensions (minimum 1200x800)
          - The app appears in the Dock with the Orion icon
        </then>
      </criterion>
      <criterion id="AC2" name="Graceful Shutdown">
        <given>The app is running</given>
        <when>I close the window</when>
        <then>The app quits gracefully without errors</then>
      </criterion>
    </acceptance-criteria>

    <dependencies>
      <dependency type="none">This is the first story - no dependencies</dependency>
      <blocks>
        <story>1-2-nextjs-frontend-integration</story>
        <story>1-5-agent-server-process</story>
      </blocks>
      <can-parallel>
        <story>1-3-design-system-foundation</story>
      </can-parallel>
    </dependencies>

    <tasks>
      <task id="1" name="Tauri 2.0 Project Scaffolding" ac="AC1">
        <subtask>Initialize Tauri 2.0 project with pnpm create tauri-app@latest using pnpm preset</subtask>
        <subtask>Configure Rust toolchain for macOS (stable channel)</subtask>
        <subtask>Set up pnpm workspace configuration in pnpm-workspace.yaml</subtask>
        <subtask>Verify Tauri CLI is installed: pnpm tauri --version</subtask>
      </task>
      <task id="2" name="Configure tauri.conf.json" ac="AC1,AC2">
        <subtask>Set productName to "Orion"</subtask>
        <subtask>Set identifier to "com.orion.butler"</subtask>
        <subtask>Configure window dimensions: width=1400, height=900, minWidth=1200, minHeight=800</subtask>
        <subtask>Set titleBarStyle to "Overlay" for native macOS look</subtask>
        <subtask>Set decorations: true, resizable: true</subtask>
        <subtask>Configure bundle targets: ["dmg", "app"]</subtask>
        <subtask>Set macOS.minimumSystemVersion to "12.0"</subtask>
        <subtask>Configure icon paths in bundle section</subtask>
      </task>
      <task id="3" name="Create App Icons" ac="AC1">
        <subtask>Create icon set in src-tauri/icons/: 32x32.png, 128x128.png, 128x128@2x.png, icon.icns, tray.png</subtask>
        <subtask>Use placeholder icons initially (can be replaced later)</subtask>
      </task>
      <task id="4" name="Rust Main Process Setup" ac="AC1,AC2">
        <subtask>Create src-tauri/src/main.rs with basic Tauri builder</subtask>
        <subtask>Implement setup hook for initialization</subtask>
        <subtask>Implement on_window_event handler for CloseRequested</subtask>
        <subtask>Add logging for startup/shutdown events</subtask>
      </task>
      <task id="5" name="Basic Frontend Placeholder" ac="AC1">
        <subtask>Create minimal src/ directory with Next.js stub</subtask>
        <subtask>Add simple index page that displays "Orion Loading..."</subtask>
        <subtask>Configure build.frontendDist to point to Next.js output</subtask>
        <subtask>Configure build.devUrl to "http://localhost:3000"</subtask>
      </task>
      <task id="6" name="macOS Entitlements" ac="AC1,AC2">
        <subtask>Create src-tauri/Entitlements.plist with required capabilities</subtask>
        <subtask>Include: com.apple.security.network.client, com.apple.security.files.user-selected.read-write, com.apple.security.files.bookmarks.app-scope</subtask>
      </task>
      <task id="7" name="Build and Test" ac="AC1,AC2">
        <subtask>Run pnpm tauri dev - verify hot reload works</subtask>
        <subtask>Run pnpm tauri build - verify DMG is created</subtask>
        <subtask>Install built app and verify Dock icon appears</subtask>
        <subtask>Measure launch time (must be less than 3 seconds)</subtask>
        <subtask>Verify clean exit with no error logs</subtask>
      </task>
    </tasks>

    <technical-notes>
      <note category="constraints">
        <item key="Desktop Framework">Tauri 2.0 (Source: architecture.md#1.3)</item>
        <item key="Minimum macOS">12.0 Monterey (Source: architecture.md#8.1)</item>
        <item key="Package Manager">pnpm (Source: architecture.md#3.2)</item>
        <item key="Window Min Size">1200x800 (Source: epics.md#Story 1.1)</item>
        <item key="Launch Time">Less than 3 seconds (NFR-P003)</item>
      </note>
      <note category="tauri-2.0-specifics">
        Tauri 2.0 has breaking changes from 1.x:
        - Config file schema changed: use $schema: "https://tauri.app/v2/tauri.conf.json"
        - Plugin system is completely different - plugins declared in plugins section
        - app.windows replaces tauri.windows
        - app.security.csp replaces tauri.security.csp
        - bundle.macOS replaces tauri.bundle.macOS
      </note>
      <note category="rust-toolchain">
        - Requires Rust stable (not nightly)
        - macOS requires Xcode Command Line Tools
        - CLI installation: pnpm add -D @tauri-apps/cli@next
      </note>
      <note category="graceful-shutdown">
        - Must handle CloseRequested event in on_window_event
        - Future stories (1.5) will add agent server cleanup here
      </note>
    </technical-notes>

    <file-structure>
      <files-to-create>
        <file path="src-tauri/src/main.rs">Basic Tauri entry point</file>
        <file path="src-tauri/icons/32x32.png">App icon 32x32</file>
        <file path="src-tauri/icons/128x128.png">App icon 128x128</file>
        <file path="src-tauri/icons/128x128@2x.png">App icon retina</file>
        <file path="src-tauri/icons/icon.icns">macOS app icon</file>
        <file path="src-tauri/icons/tray.png">System tray icon</file>
        <file path="src-tauri/tauri.conf.json">Tauri configuration</file>
        <file path="src-tauri/Cargo.toml">Rust dependencies</file>
        <file path="src-tauri/Entitlements.plist">macOS entitlements</file>
        <file path="src/app/page.tsx">Minimal placeholder page</file>
        <file path="pnpm-workspace.yaml">Workspace config</file>
        <file path=".env.example">Environment template</file>
      </files-to-create>
      <files-to-modify>
        <file path="package.json">Add tauri scripts</file>
      </files-to-modify>
    </file-structure>
  </story>

  <tests>
    <atdd-checklist-ref>atdd-checklist-1-1-tauri-desktop-shell.md</atdd-checklist-ref>
    <test-summary>
      <total-tests>16</total-tests>
      <by-type>
        <happy-path count="5">
          <test id="1.1.1">App launches successfully from icon</test>
          <test id="1.1.2">App launches within NFR-P003 threshold (less than 3 seconds)</test>
          <test id="1.1.3">Window has correct minimum dimensions</test>
          <test id="1.2.1">App quits cleanly with exit code 0</test>
          <test id="1.2.2">No orphan processes after quit</test>
        </happy-path>
        <edge-cases count="7">
          <test id="1.1.4">App launches on macOS 12 Monterey (minimum supported)</test>
          <test id="1.1.5">App launches on macOS 13+ (Ventura/Sonoma/Sequoia)</test>
          <test id="1.1.6">Window respects minimum size on resize attempt</test>
          <test id="1.1.7">App icon appears in Dock during runtime</test>
          <test id="1.2.3">Multiple close attempts are idempotent</test>
          <test id="1.2.4">Force quit (Cmd+Option+Escape) terminates cleanly</test>
          <test id="1.2.5">Close during startup is handled</test>
        </edge-cases>
        <error-handling count="4">
          <test id="1.1.8">Launch failure produces meaningful error log</test>
          <test id="1.1.9">Missing frontend gracefully shows placeholder</test>
          <test id="1.2.6">Shutdown logs are written without errors</test>
          <test id="1.2.7">Shutdown completes even if frontend has errors</test>
        </error-handling>
      </by-type>
      <unit-tests count="4">
        <test id="1.U.1">tauri.conf.json has correct window dimensions</test>
        <test id="1.U.2">macOS minimum version is 12.0</test>
        <test id="1.U.3">Product name and identifier are correct</test>
        <test id="1.U.4">Icon files exist at required paths</test>
      </unit-tests>
    </test-summary>
    <test-files>
      <file>tests/e2e/story-1.1-tauri-shell.spec.ts</file>
      <file>tests/unit/story-1.1-config.spec.ts</file>
      <file>tests/integration/story-1.1-launch-errors.spec.ts</file>
      <file>tests/integration/story-1.1-shutdown.spec.ts</file>
    </test-files>
    <gate-criteria>
      <criterion>All 16 tests pass (5 happy path + 7 edge cases + 4 error handling)</criterion>
      <criterion>Launch time less than 3 seconds (NFR-P003) verified</criterion>
      <criterion>No P0/P1 bugs open</criterion>
      <criterion>Manual verification of Dock icon appearance documented</criterion>
    </gate-criteria>
  </tests>

  <architecture>
    <relevant-sections>
      <section name="8. Tauri Integration">
        <subsection name="8.1 Tauri Configuration">
          Reference tauri.conf.json structure with Tauri 2.0 schema
        </subsection>
        <subsection name="8.2 Rust Main Process">
          Basic main.rs structure with setup and event handlers
        </subsection>
      </section>
      <section name="3. Tech Stack">
        <subsection name="3.1 Core Technologies">
          Tauri 2.0 for native wrapper, IPC, system access
        </subsection>
      </section>
      <section name="2. System Architecture">
        <subsection name="2.1 High-Level Architecture">
          TAURI SHELL (Rust) - Window mgmt, File system, System tray, IPC bridge
        </subsection>
        <subsection name="2.2 Process Architecture">
          Tauri Main Process (Rust) with WebView (Next.js/React) and Agent Server (Node.js) as child process
        </subsection>
      </section>
    </relevant-sections>

    <patterns-to-follow>
      <pattern name="Tauri 2.0 Config Schema">
        Use $schema: "https://tauri.app/v2/tauri.conf.json" for config validation
      </pattern>
      <pattern name="Window Configuration">
        Configure windows under app.windows array (not tauri.windows)
      </pattern>
      <pattern name="Plugin Declaration">
        Declare plugins in plugins section (fs, shell, process, notification, dialog)
      </pattern>
      <pattern name="macOS Bundle">
        Configure macOS-specific settings under bundle.macOS (not tauri.bundle.macOS)
      </pattern>
      <pattern name="Security CSP">
        Set CSP under app.security.csp (not tauri.security.csp)
      </pattern>
      <pattern name="Event Handling">
        Use on_window_event for CloseRequested to ensure graceful shutdown
      </pattern>
    </patterns-to-follow>

    <tauri-config-reference>
      <![CDATA[
{
  "$schema": "https://tauri.app/v2/tauri.conf.json",
  "productName": "Orion",
  "identifier": "com.orion.butler",
  "version": "0.1.0",
  "build": {
    "beforeBuildCommand": "pnpm build",
    "beforeDevCommand": "pnpm dev",
    "frontendDist": "../out",
    "devUrl": "http://localhost:3000"
  },
  "bundle": {
    "active": true,
    "targets": ["dmg", "app"],
    "icon": [
      "icons/32x32.png",
      "icons/128x128.png",
      "icons/128x128@2x.png",
      "icons/icon.icns"
    ],
    "macOS": {
      "minimumSystemVersion": "12.0",
      "signingIdentity": "-",
      "entitlements": "Entitlements.plist"
    }
  },
  "app": {
    "windows": [{
      "title": "Orion",
      "width": 1400,
      "height": 900,
      "minWidth": 1200,
      "minHeight": 800,
      "resizable": true,
      "fullscreen": false,
      "decorations": true,
      "transparent": false,
      "titleBarStyle": "Overlay"
    }],
    "security": {
      "csp": "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'"
    },
    "trayIcon": {
      "iconPath": "icons/tray.png",
      "iconAsTemplate": true
    }
  },
  "plugins": {
    "fs": {
      "scope": ["$APPDATA/**", "$HOME/Library/Application Support/Orion/**"]
    },
    "shell": { "open": true, "scope": [] },
    "process": {},
    "notification": {},
    "dialog": {}
  }
}
      ]]>
    </tauri-config-reference>
  </architecture>

  <dev-instructions>
    <instruction priority="high">
      This story creates the Tauri shell ONLY. Do not implement the full agent server
      or Next.js application - those are separate stories (1.2, 1.5).
    </instruction>
    <instruction priority="high">
      Use Tauri 2.0 syntax throughout. Tauri 1.x patterns will not work.
    </instruction>
    <instruction priority="high">
      Placeholder frontend should be minimal - just enough to verify the shell works.
    </instruction>
    <instruction priority="medium">
      Placeholder icons are acceptable for this story - design will be finalized later.
    </instruction>
    <instruction priority="medium">
      Launch time measurement is critical - this is an NFR that will be tested.
    </instruction>
  </dev-instructions>
</story-context>
