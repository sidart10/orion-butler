<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: 1-7-claude-integration
  Generated: 2026-01-15
  Updated: 2026-01-17
  Status: implemented

  This file contains all context needed for DEV agent implementation.

  IMPLEMENTATION NOTE (2026-01-17):
  The actual implementation UPGRADED from the original spec:
  - Original spec: @anthropic-ai/sdk (Messages API)
  - Actual impl: @anthropic-ai/claude-agent-sdk (Agent SDK with claudeQuery)

  This is a superior approach - the Agent SDK manages conversation context
  via sessionId rather than manually sending message history.
-->
<story-context xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- ================================================================== -->
  <!-- STORY IDENTIFICATION -->
  <!-- ================================================================== -->
  <metadata>
    <story-id>1-7-claude-integration</story-id>
    <epic>1 - MVP Foundation</epic>
    <title>Claude Integration</title>
    <status>implemented</status>
    <generated>2026-01-15</generated>
    <updated>2026-01-17</updated>
    <prerequisites>
      <story>1-5-agent-server-process</story>
      <story>1-6-chat-message-storage</story>
    </prerequisites>
    <parallel-stories>
      <story>1-9-split-screen-layout</story>
    </parallel-stories>
    <enables>
      <story>1-8-streaming-responses</story>
    </enables>
  </metadata>

  <!-- ================================================================== -->
  <!-- USER STORY -->
  <!-- ================================================================== -->
  <user-story>
    <as-a>user</as-a>
    <i-want>to chat with Claude through Orion</i-want>
    <so-that>I can get AI assistance for my daily tasks</so-that>
  </user-story>

  <!-- ================================================================== -->
  <!-- ACCEPTANCE CRITERIA SUMMARY -->
  <!-- ================================================================== -->
  <acceptance-criteria>
    <ac id="AC1" title="Basic Message Round-Trip">
      <description>Message sent to Claude API via Agent Server, response displayed and persisted</description>
      <key-points>
        <point>API key from environment or user configuration</point>
        <point>User message and assistant response stored in database</point>
        <point>Token counts extracted from API response</point>
      </key-points>
    </ac>

    <ac id="AC2" title="Conversation Context Maintenance">
      <description>Previous conversation context included in API calls</description>
      <implementation-note>UPGRADED: Uses SDK sessionId instead of manual history</implementation-note>
      <key-points>
        <point>SDK sessionId passed to claudeQuery() for context continuity</point>
        <point>Claude demonstrates awareness of conversation history</point>
        <point>SDK session ID stored in conversation record and returned to frontend</point>
        <point>No manual message history needed - SDK manages server-side</point>
      </key-points>
    </ac>

    <ac id="AC3" title="Invalid API Key Handling">
      <description>Clear error message for authentication failures</description>
      <key-points>
        <point>401 errors mapped to AUTH_ERROR code</point>
        <point>User prompted to configure API key</point>
        <point>Error state recoverable without app restart</point>
      </key-points>
    </ac>

    <ac id="AC4" title="API Key Validation">
      <description>Malformed keys rejected locally, valid format keys validated via API</description>
      <key-points>
        <point>Key must start with "sk-ant-"</point>
        <point>Minimum 40+ characters after prefix</point>
        <point>Validation result within 3 seconds</point>
      </key-points>
    </ac>

    <ac id="AC5" title="Network Error Handling">
      <description>User-friendly error display with retry capability</description>
      <key-points>
        <point>Network errors mapped to NETWORK_ERROR code</point>
        <point>Retry button allows resending without retyping</point>
        <point>Failed message stored for retry</point>
      </key-points>
    </ac>

    <ac id="AC6" title="Rate Limit Handling">
      <description>429 errors display retry-after timing with countdown</description>
      <key-points>
        <point>Rate limit mapped to RATE_LIMITED code</point>
        <point>Countdown timer from retry-after header</point>
        <point>Retry enabled after countdown completes</point>
      </key-points>
    </ac>

    <ac id="AC7" title="Model Configuration">
      <description>Configurable model with beta headers for structured outputs</description>
      <key-points>
        <point>Default model: claude-sonnet-4-5-20250514</point>
        <point>Override via CLAUDE_MODEL environment variable</point>
        <point>Beta header: structured-outputs-2025-11-13</point>
      </key-points>
    </ac>

    <ac id="AC8" title="Token Usage Tracking">
      <description>Input and output tokens extracted and stored per message</description>
      <key-points>
        <point>Extract from response.usage.input_tokens and output_tokens</point>
        <point>Store with assistant message record</point>
        <point>Enable total conversation token calculation</point>
      </key-points>
    </ac>
  </acceptance-criteria>

  <!-- ================================================================== -->
  <!-- ATDD TEST SUMMARY -->
  <!-- ================================================================== -->
  <atdd-summary>
    <reference-file>thoughts/implementation-artifacts/stories/atdd-checklist-1-7-claude-integration.md</reference-file>
    <test-counts>
      <unit-tests count="30">
        <focus>API key validation, error mapping, token extraction, message building</focus>
      </unit-tests>
      <integration-tests count="16">
        <focus>Full round-trip, context maintenance, error responses</focus>
      </integration-tests>
      <e2e-tests count="18">
        <focus>User sends message, sees response, error recovery</focus>
      </e2e-tests>
      <cross-cutting count="5">
        <focus>Agent Server unavailable, rapid sends, state consistency</focus>
      </cross-cutting>
    </test-counts>
    <mock-strategies>
      <mock component="Claude Agent SDK">vitest.mock('@anthropic-ai/claude-agent-sdk')</mock>
      <mock component="Agent Server">msw (Mock Service Worker)</mock>
      <mock component="Tauri IPC">Mock invoke() function</mock>
    </mock-strategies>
  </atdd-summary>

  <!-- ================================================================== -->
  <!-- ARCHITECTURE PATTERNS -->
  <!-- ================================================================== -->
  <architecture>

    <pattern id="ARCH-001" title="Agent Server Architecture">
      <description>Agent Server runs as child process on localhost:3001</description>
      <code-sample language="typescript"><![CDATA[
// agent-server/src/index.ts
const PORT = process.env.PORT || 3001;

app.use(cors({
  origin: ['tauri://localhost', 'http://localhost:3000'],
}));
      ]]></code-sample>
    </pattern>

    <pattern id="ARCH-002" title="Claude Agent SDK Integration">
      <description>Use @anthropic-ai/claude-agent-sdk for agentic AI interactions with session management</description>
      <implementation-note>UPGRADED from original Messages API spec to Agent SDK for superior context handling</implementation-note>
      <code-sample language="typescript"><![CDATA[
// ACTUAL IMPLEMENTATION - Claude Agent SDK
import { query as claudeQuery, type Options } from '@anthropic-ai/claude-agent-sdk';

export class ClaudeAgentClient {
  private model: string;

  constructor(config: ClaudeClientConfig) {
    // SDK reads from ANTHROPIC_API_KEY env var
    process.env.ANTHROPIC_API_KEY = config.apiKey;
    this.model = config.model || 'claude-sonnet-4-5-20250514';
  }

  async sendMessage(
    userMessage: string,
    systemPrompt?: string,
    sessionId?: string  // SDK manages context via sessionId
  ): Promise<ClaudeResponse> {
    const options: Options = {
      model: this.model,
      maxTurns: 1,
      ...(sessionId && { sessionId }),  // Resume existing session
    };

    // SDK streaming query - handles agentic loop internally
    for await (const sdkMessage of claudeQuery({ prompt, options })) {
      // Process streaming events: text, tool_start, tool_result, etc.
    }
  }
}
      ]]></code-sample>
      <benefits>
        <benefit>Session-based context: SDK maintains conversation server-side via sessionId</benefit>
        <benefit>No manual history: Don't need to send last 20 messages each request</benefit>
        <benefit>Tool support: Built-in support for tool calling and agentic loops</benefit>
        <benefit>Streaming native: claudeQuery is async generator for real-time updates</benefit>
      </benefits>
    </pattern>

    <pattern id="ARCH-003" title="Data Flow">
      <description>User Input -> WebView -> Tauri IPC -> Agent Server -> Claude API -> Response</description>
      <diagram><![CDATA[
User Input -> WebView -> Tauri IPC -> Agent Server -> Claude API
                                          |
                                          v
                                    Tool Execution
                                    (Composio/Local)
                                          |
                                          v
                                    Stream Response
                                          |
                                          v
                         Agent Server -> Tauri IPC -> WebView -> UI Update
      ]]></diagram>
    </pattern>

    <pattern id="ARCH-004" title="Conversation Context">
      <description>SQLite stores conversations with SDK session ID</description>
      <code-sample language="sql"><![CDATA[
CREATE TABLE conversations (
    id TEXT PRIMARY KEY,                     -- conv_xxx format
    sdk_session_id TEXT,                     -- Claude SDK session ID
    title TEXT,
    summary TEXT,
    message_count INTEGER DEFAULT 0,
    last_message_at TEXT
);
      ]]></code-sample>
    </pattern>

    <pattern id="ARCH-005" title="Structured Outputs">
      <description>Use beta header for type-safe responses</description>
      <code-sample language="typescript"><![CDATA[
// Beta headers for Claude API features
const BETA_HEADERS = {
  'anthropic-beta': 'structured-outputs-2025-11-13',
};

// For extended thinking (future)
// 'anthropic-beta': 'structured-outputs-2025-11-13,interleaved-thinking-2025-05-14'
      ]]></code-sample>
    </pattern>

    <pattern id="ARCH-006" title="Prompt Caching">
      <description>Cache system prompts to reduce costs</description>
      <details>
        <item>Minimum cacheable tokens: 1,024 (Sonnet 4.5)</item>
        <item>Cache writes: 25% premium on first use</item>
        <item>Cache reads: 90% discount on subsequent uses</item>
        <item>Cache TTL: 5 minutes of inactivity</item>
      </details>
    </pattern>

  </architecture>

  <!-- ================================================================== -->
  <!-- IMPLEMENTATION TASKS -->
  <!-- ================================================================== -->
  <tasks>

    <task id="1" title="API Key Management" acs="AC3,AC4">
      <subtasks>
        <subtask id="1.1">Create agent-server/src/config/api-keys.ts with format validation</subtask>
        <subtask id="1.2">Create API key validation endpoint POST /api/chat/validate-key</subtask>
        <subtask id="1.3">Implement getApiKey() from environment variable</subtask>
        <subtask id="1.4">Create frontend ApiKeyInput component</subtask>
      </subtasks>
      <key-implementation><![CDATA[
// Anthropic API key format validation
const ANTHROPIC_KEY_PATTERN = /^sk-ant-[a-zA-Z0-9-_]{40,}$/;

export function validateApiKeyFormat(apiKey: string): { valid: boolean; error?: string } {
  if (!apiKey || apiKey.trim() === '') {
    return { valid: false, error: 'API key is required' };
  }
  if (!apiKey.startsWith('sk-ant-')) {
    return { valid: false, error: 'Invalid API key format: must start with "sk-ant-"' };
  }
  if (!ANTHROPIC_KEY_PATTERN.test(apiKey)) {
    return { valid: false, error: 'Invalid API key format: incorrect length or characters' };
  }
  return { valid: true };
}
      ]]></key-implementation>
    </task>

    <task id="2" title="Claude Client Setup" acs="AC1,AC7,AC8">
      <subtasks>
        <subtask id="2.1">Create agent-server/src/services/claude-client.ts</subtask>
        <subtask id="2.2">Implement sendMessage with conversation history support</subtask>
        <subtask id="2.3">Extract token counts from API response</subtask>
        <subtask id="2.4">Add beta headers for structured outputs</subtask>
      </subtasks>
      <key-types><![CDATA[
export interface ClaudeClientConfig {
  apiKey: string;
  model?: string;
  maxTokens?: number;
}

export interface ConversationMessage {
  role: 'user' | 'assistant';
  content: string;
}

export interface ClaudeResponse {
  content: string;
  inputTokens: number;
  outputTokens: number;
  stopReason: string;
  model: string;
}
      ]]></key-types>
    </task>

    <task id="3" title="Agent Server Chat Endpoint" acs="AC1,AC2,AC5,AC6">
      <subtasks>
        <subtask id="3.1">Create agent-server/src/routes/chat.ts</subtask>
        <subtask id="3.2">Implement POST /api/chat/message endpoint</subtask>
        <subtask id="3.3">Implement GET /api/chat/health endpoint</subtask>
        <subtask id="3.4">Create handleClaudeError for error mapping</subtask>
      </subtasks>
      <error-codes><![CDATA[
| Code             | HTTP Status | User Message                              | Retryable |
|------------------|-------------|-------------------------------------------|-----------|
| AUTH_ERROR       | 401         | Invalid or missing API key               | No        |
| PERMISSION_ERROR | 403         | API key lacks permission                 | No        |
| RATE_LIMITED     | 429         | Rate limit exceeded                      | Yes       |
| API_ERROR        | 502         | Claude API unavailable                   | Yes       |
| NETWORK_ERROR    | 503         | Connection failed                        | Yes       |
| INVALID_INPUT    | 400         | Message required                         | No        |
| UNKNOWN_ERROR    | 500         | Unexpected error                         | Yes       |
      ]]></error-codes>
    </task>

    <task id="4" title="Frontend Chat Service" acs="AC1,AC2,AC3,AC5">
      <subtasks>
        <subtask id="4.1">Create src/lib/services/chatService.ts</subtask>
        <subtask id="4.2">Implement sendMessage with fetch to Agent Server</subtask>
        <subtask id="4.3">Implement checkHealth for API status</subtask>
        <subtask id="4.4">Implement validateApiKey endpoint call</subtask>
      </subtasks>
      <key-interface><![CDATA[
export interface ChatError {
  error: string;
  code: string;
  retryable: boolean;
  retryAfter?: number;
}

export interface SendMessageResult {
  success: boolean;
  message?: Message;
  error?: ChatError;
}
      ]]></key-interface>
    </task>

    <task id="5" title="Update Chat Store" acs="AC1,AC2,AC5,AC6">
      <subtasks>
        <subtask id="5.1">Extend src/stores/chatStore.ts from Story 1.6</subtask>
        <subtask id="5.2">Add isSending, sendError, retryMessage state</subtask>
        <subtask id="5.3">Implement sendMessage action with history building</subtask>
        <subtask id="5.4">Implement retrySend and clearSendError actions</subtask>
      </subtasks>
    </task>

    <task id="6" title="Error Display Component" acs="AC3,AC5,AC6">
      <subtasks>
        <subtask id="6.1">Create src/components/chat/ChatError.tsx</subtask>
        <subtask id="6.2">Implement countdown timer for rate limits</subtask>
        <subtask id="6.3">Add action buttons (retry, configure API key)</subtask>
        <subtask id="6.4">Style with Orion Design System tokens</subtask>
      </subtasks>
    </task>

    <task id="7" title="API Key Entry UI" acs="AC3,AC4">
      <subtasks>
        <subtask id="7.1">Create src/components/settings/ApiKeyInput.tsx</subtask>
        <subtask id="7.2">Add password field with show/hide toggle</subtask>
        <subtask id="7.3">Implement real-time format validation feedback</subtask>
        <subtask id="7.4">Add link to Anthropic console</subtask>
      </subtasks>
    </task>

    <task id="8" title="Tauri IPC for Assistant Messages" acs="AC1,AC8">
      <subtasks>
        <subtask id="8.1">Extend src-tauri/src/commands/chat.rs</subtask>
        <subtask id="8.2">Add save_assistant_message command</subtask>
        <subtask id="8.3">Include input_tokens and output_tokens fields</subtask>
        <subtask id="8.4">Update conversation stats on save</subtask>
      </subtasks>
    </task>

    <task id="9" title="Chat Input Integration" acs="AC1">
      <subtasks>
        <subtask id="9.1">Update src/components/chat/ChatInput.tsx</subtask>
        <subtask id="9.2">Add Cmd+Enter keyboard shortcut</subtask>
        <subtask id="9.3">Integrate error display component</subtask>
        <subtask id="9.4">Add disabled state during sending</subtask>
      </subtasks>
    </task>

    <task id="10" title="Agent Server Initialization" acs="AC7">
      <subtasks>
        <subtask id="10.1">Update agent-server/src/index.ts</subtask>
        <subtask id="10.2">Add CORS configuration for Tauri origin</subtask>
        <subtask id="10.3">Initialize Claude client on startup</subtask>
        <subtask id="10.4">Add global error handling middleware</subtask>
      </subtasks>
    </task>

    <task id="11" title="Unit Tests" acs="AC1,AC4,AC5">
      <subtasks>
        <subtask id="11.1">Test API key format validation</subtask>
        <subtask id="11.2">Test Claude client message building</subtask>
        <subtask id="11.3">Test error code mapping</subtask>
        <subtask id="11.4">Test token extraction from response</subtask>
      </subtasks>
    </task>

    <task id="12" title="Integration Tests" acs="AC1,AC2,AC5,AC6">
      <subtasks>
        <subtask id="12.1">Test full message round-trip</subtask>
        <subtask id="12.2">Test conversation context maintenance</subtask>
        <subtask id="12.3">Test error handling for various API errors</subtask>
        <subtask id="12.4">Test Agent Server health endpoint</subtask>
      </subtasks>
    </task>

    <task id="13" title="E2E Tests" acs="AC1,AC3,AC5">
      <subtasks>
        <subtask id="13.1">Create Playwright test for chat flow</subtask>
        <subtask id="13.2">Test error display and recovery</subtask>
        <subtask id="13.3">Test message persistence across reload</subtask>
      </subtasks>
    </task>

  </tasks>

  <!-- ================================================================== -->
  <!-- DIRECTORY STRUCTURE -->
  <!-- ================================================================== -->
  <directory-structure>
    <files-to-create>
      <file path="agent-server/src/config/api-keys.ts">API key management</file>
      <file path="agent-server/src/services/claude-client.ts">Claude SDK wrapper</file>
      <file path="agent-server/src/routes/chat.ts">Chat API endpoints</file>
      <file path="src/lib/services/chatService.ts">Frontend chat service</file>
      <file path="src/components/chat/ChatError.tsx">Error display component</file>
      <file path="src/components/settings/ApiKeyInput.tsx">API key entry UI</file>
      <file path="tests/unit/services/api-keys.test.ts">API key validation tests</file>
      <file path="tests/integration/chat/claude-integration.test.ts">Claude API tests</file>
      <file path="tests/e2e/chat-claude.spec.ts">E2E chat tests</file>
    </files-to-create>
    <files-to-modify>
      <file path="agent-server/src/index.ts">Add chat routes, CORS, Claude init</file>
      <file path="src/stores/chatStore.ts">Add Claude integration state/actions</file>
      <file path="src/components/chat/ChatInput.tsx">Add send integration</file>
      <file path="src-tauri/src/commands/chat.rs">Add assistant message save</file>
    </files-to-modify>
  </directory-structure>

  <!-- ================================================================== -->
  <!-- DEPENDENCIES -->
  <!-- ================================================================== -->
  <dependencies>
    <new-packages location="agent-server">
      <package name="@anthropic-ai/claude-agent-sdk" version="^0.2.9" purpose="Claude Agent SDK - agentic AI with session management" status="installed" />
      <package name="express" version="^4.21.2" purpose="HTTP server" status="installed" />
      <package name="cors" version="^2.8.5" purpose="CORS middleware" status="installed" />
      <package name="better-sqlite3" version="^11.7.0" purpose="SQLite database" status="installed" />
      <package name="@types/express" dev="true" status="installed" />
      <package name="@types/cors" dev="true" status="installed" />
      <package name="@types/better-sqlite3" dev="true" status="installed" />
    </new-packages>
    <deprecated-from-spec>
      <package name="@anthropic-ai/sdk" reason="Replaced by @anthropic-ai/claude-agent-sdk for agentic capabilities" />
    </deprecated-from-spec>
    <existing-packages>
      <note>Frontend uses existing fetch API and Tauri invoke - no new packages required</note>
    </existing-packages>
  </dependencies>

  <!-- ================================================================== -->
  <!-- ENVIRONMENT VARIABLES -->
  <!-- ================================================================== -->
  <environment-variables>
    <variable name="ANTHROPIC_API_KEY" required="true">
      <description>Anthropic API key starting with sk-ant-</description>
      <example>sk-ant-api03-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</example>
    </variable>
    <variable name="CLAUDE_MODEL" required="false">
      <description>Override default Claude model</description>
      <default>claude-sonnet-4-5-20250514</default>
    </variable>
    <variable name="AGENT_SERVER_PORT" required="false">
      <description>Agent Server port</description>
      <default>3001</default>
    </variable>
  </environment-variables>

  <!-- ================================================================== -->
  <!-- PERFORMANCE TARGETS -->
  <!-- ================================================================== -->
  <performance-targets>
    <target metric="Time to first token" value="&lt;500ms" source="NFR-P001" />
    <target metric="API key validation" value="&lt;3 seconds" source="AC4" />
    <target metric="Error display" value="Immediate" source="After API response" />
    <target metric="Retry countdown" value="Accurate to second" source="UI timer" />
  </performance-targets>

  <!-- ================================================================== -->
  <!-- DESIGN SYSTEM INTEGRATION -->
  <!-- ================================================================== -->
  <design-system>
    <css-classes>
      <class name="btn-gold-slide">Primary CTA with gold slide-in hover effect</class>
      <class name="input-editorial">Underline-only input with serif italic placeholder</class>
      <class name="chat-user">User message (black bg, cream text)</class>
      <class name="chat-agent">Agent message (gold left border)</class>
    </css-classes>
    <color-tokens>
      <token name="--orion-primary" value="#D4AF37" usage="CTAs, highlights" />
      <token name="--orion-bg" value="#F9F8F6" usage="Page background" />
      <token name="--orion-fg" value="#1A1A1A" usage="Text, borders" />
    </color-tokens>
  </design-system>

  <!-- ================================================================== -->
  <!-- TECHNICAL NOTES -->
  <!-- ================================================================== -->
  <technical-notes>
    <note id="1" title="API Key Security">
      <content>API key stored in environment variable only (not database or frontend). Never log or expose in error messages. Consider macOS Keychain integration post-MVP.</content>
    </note>
    <note id="2" title="Conversation Context">
      <content>UPDATED: Uses Claude Agent SDK sessionId for context management instead of manual message history. SDK maintains conversation server-side. sessionId returned from each response and passed to subsequent requests for continuity. System prompt sent with each request via BUTLER_SYSTEM_PROMPT constant.</content>
    </note>
    <note id="3" title="Error Recovery">
      <content>Store failed message for retry capability. Clear retry state on successful send. Auto-retry after rate limit countdown.</content>
    </note>
    <note id="4" title="Token Tracking">
      <content>Extract from response.usage.input_tokens and output_tokens. Store per-message for cost analysis. Consider aggregating at conversation level.</content>
    </note>
    <note id="5" title="Model Configuration">
      <content>Default to claude-sonnet-4-5 for balance of speed and quality. Allow override via CLAUDE_MODEL environment variable. Include beta headers for future structured outputs support.</content>
    </note>
  </technical-notes>

  <!-- ================================================================== -->
  <!-- IMPLEMENTATION STATUS (Added 2026-01-17) -->
  <!-- ================================================================== -->
  <implementation-status updated="2026-01-17">
    <summary>Story implemented with upgrade from Messages API to Claude Agent SDK</summary>

    <completed-items>
      <item task="1" file="agent-server/src/config/api-keys.ts">API key format validation with sk-ant- pattern</item>
      <item task="2" file="agent-server/src/services/claude-client.ts">ClaudeAgentClient with claudeQuery() and streaming</item>
      <item task="3" file="agent-server/src/routes/chat.ts">POST /api/chat/message, GET /api/chat/health endpoints</item>
      <item task="4" file="src/lib/services/chatService.ts">Frontend ChatService with sendMessage, checkHealth, validateApiKey</item>
      <item task="6" file="src/components/chat/ChatError.tsx">Error display with countdown timer and retry buttons</item>
      <item task="7" file="src/components/settings/ApiKeyInput.tsx">API key input with show/hide toggle and validation</item>
      <item task="10" file="agent-server/src/index.ts">Express server with CORS and chat routes</item>
    </completed-items>

    <minor-gaps>
      <gap id="1" severity="low">
        <description>Rate limit retryAfter hardcoded to 60s instead of parsing from header</description>
        <location>agent-server/src/routes/chat.ts:179</location>
        <recommendation>Parse actual retry-after header when available</recommendation>
      </gap>
      <gap id="2" severity="low">
        <description>API key validation is format-only (no API call) for MVP cost savings</description>
        <location>agent-server/src/routes/chat.ts:156-158</location>
        <recommendation>Add optional full API validation post-MVP</recommendation>
      </gap>
    </minor-gaps>

    <upgrade-from-spec>
      <original>@anthropic-ai/sdk with Messages API and manual 20-message history</original>
      <actual>@anthropic-ai/claude-agent-sdk with claudeQuery() and sessionId-based context</actual>
      <rationale>Agent SDK provides superior context management, built-in streaming, and tool support</rationale>
    </upgrade-from-spec>
  </implementation-status>

  <!-- ================================================================== -->
  <!-- REFERENCES -->
  <!-- ================================================================== -->
  <references>
    <reference type="architecture" path="thoughts/planning-artifacts/architecture.md#3.3">Claude API Features</reference>
    <reference type="architecture" path="thoughts/planning-artifacts/architecture.md#5.3">Agent Server API</reference>
    <reference type="architecture" path="thoughts/planning-artifacts/architecture.md#6.5">Claude Agent SDK Built-in Tools</reference>
    <reference type="architecture" path="thoughts/planning-artifacts/architecture.md#6.7">Prompt Caching</reference>
    <reference type="story" path="thoughts/implementation-artifacts/stories/story-1-5-agent-server-process.md">Agent Server Process (prerequisite)</reference>
    <reference type="story" path="thoughts/implementation-artifacts/stories/story-1-6-chat-message-storage.md">Chat Message Storage (prerequisite)</reference>
    <reference type="atdd" path="thoughts/implementation-artifacts/stories/atdd-checklist-1-7-claude-integration.md">Full ATDD Checklist</reference>
  </references>

</story-context>
